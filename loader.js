/****** GENERATED BY LOCAL PROXY ************/



/**
 * Created by yoni.f on 6/14/16.
 */
(function (perfApi, win) {

    win.TRC = win.TRC || {};

    if (typeof perfApi !== 'object' || typeof perfApi.now !== 'function') {
        return;
    }
    var doNothing = function () {

    };

    // polifill mark and measure
    if (!perfApi.mark || typeof perfApi.mark !== "function") {
        perfApi.mark = doNothing;
    }
    TRC.PerfEvenType = {
        START: 'start',
        STOP: 'stop',
        MARK: 'mark',
        REQ_LEVEL_START: 'startReq',
        REQ_LEVEL_STOP: 'stopReq'
    };

    TRC.Performance = function (_config) {
        var config = _config || {},
            prefix = 'tbl_' + Date.now() + "_",
            eventLoops = [],
            eventLoopCheckInterval = TRC.EVENT_LOOP_INTERVAL,
            eventLoopCounter = 1,
            maxEventLoopToStore = 20,
            eventLoopReportInterval = TRC.EVENT_LOOP_REPORT_INTERVAL;
        this.perfString = "";
        this.timeout = null;
        this.modeEvents = {};
        this.measurementIds = [];
        this.modeDictionery = {};
        this.measurements = [];
        this.vitalsCls = 0;
        this.vitalsClsMax = 0;
        this.fpsMeasurements = [];
        this.eventLoopMeasurements = [];
        this.measurementsCollection = [];
        this.firstIterationFlag = true;
        config.measures = config.measures || {};
        // inserting hardcoded measurements
        // underscore is used to split the measure name from mesure type. use underscore
        config.measures['generalMeasure_loaderLoaded'] = [prefix + "2.0", prefix + "measuring"];
        config.measures['generalMeasure_implLoaded'] = [prefix + "4.0", prefix + "measuring"];
        config.measures['generalMeasure_integration'] = ['tbl_ic', prefix + "measuring"];
        config.measures['generalMeasure_inflate'] = ['tbl_inflate_start', 'tbl_inflate_end' ];

        var addPerfMetric = function (paramName, paramData, startTime) {
            this.measurements.push({
                name: 'generalMeasure_' + paramName,
                entryType: "measure",
                startTime: startTime || performance.now(),
                duration: paramData
            });
        };

        this.addPageConnectionMetrics = function () {
            if (this.firstIterationFlag && navigator.connection){
                var networkInformation = navigator.connection;
                if (networkInformation.downlink){
                    addPerfMetric.call(this,  'connectionDownlink', networkInformation.downlink);
                }

                if (networkInformation.rtt){
                    addPerfMetric.call(this, 'connectionRtt', networkInformation.rtt);
                }

                if (networkInformation.effectiveType){
                    var effectiveType;
                    switch (networkInformation.effectiveType) {
                        case "slow-2g":
                            effectiveType = 1;
                            break;
                        case "2g":
                        case "3g":
                        case "4g":
                            effectiveType = networkInformation.effectiveType[0];
                            break;
                        default:
                            effectiveType = -1;
                            break;
                    }
                    addPerfMetric.call(this, 'connectionEffectiveType', Number(effectiveType));
                }
            }
        };

        this.addVitalsMetricObserver = function () {
            try {
                if(win.PerformanceObserver){
                    var trcPerformance = this;

                    var fidObserver = new win.PerformanceObserver(function (entryList)  {
                        var events = entryList.getEntries();
                        for (var i = 0; i < events.length; i++) {
                            var event = events[i];
                                var firstInputDelay = event.processingStart - event.startTime;
                                addPerfMetric.call(trcPerformance, 'firstInputDelay', firstInputDelay, event.startTime);
                        }
                    });

                    fidObserver.observe({type: 'first-input' , buffered: true});


                    var maxClsVal = 0,
                        currVal = 0,
                        firstTs = Number.NEGATIVE_INFINITY,
                        prevTs = Number.NEGATIVE_INFINITY;
                    new PerformanceObserver(function (entryList) {
                        var events = entryList.getEntries();
                        for (var i = 0; i < events.length; i++) {
                            var event = events[i];
                            if (!event.hadRecentInput) {
                                if (event.startTime - firstTs > 5000 || event.startTime - prevTs > 1000) {
                                    firstTs = event.startTime;
                                    currVal = 0;
                                }
                                prevTs = event.startTime;
                                currVal += event.value;
                                maxClsVal = Math.max(maxClsVal, currVal);
                                trcPerformance.vitalsCls += event.value;
                                trcPerformance.vitalsClsMax = maxClsVal; // new window way
                                if (TRC && TRC.dispatch) {
                                    TRC.dispatch('onCls', event);
                                }
                            }

                        }
                    }).observe({type: 'layout-shift', buffered: true});
                }
            } catch (error) {
                if(win.__trcWarn){
                    __trcWarn('faile to add taboola web vitals to perf', error);
                }
            }
        };

        this.addVitalsMetricObserver();
        this.logMeasurements = function logMeasurements(flush, shouldUseBeacon) {
            if (typeof getSessionData !== 'function') {
                return;
            }
            if(performance.now()/1000/60 > 30 && !flush){ //do not log data to server over 30 min
                return;
            }
            var domNavMark = [];
            this.measurementIds = [];
            if (!perfApi.getEntriesByName || !perfApi.measure) {
                //no browser support for measuring performance
                return;
            }

            perfApi.mark(prefix + "measuring");//mark moment of measurement
            var markCheck = perfApi.getEntriesByName(prefix + "measuring");
            //limit of events
            if (markCheck.length == 0) {
                if (perfApi.setResourceTimingBufferSize) {
                    //increase events buffer
                    perfApi.setResourceTimingBufferSize(perfApi.getEntries().length + 100);
                    perfApi.mark(prefix + "measuring");//mark moment of measurement
                }
                else {
                    return;
                }
            }
            if (this.firstIterationFlag) {
                //measure general
                for (var measure in config.measures) {
                    if (config.measures.hasOwnProperty(measure)) {
                        //check both markers exist
                        var startMark = config.measures[measure][0];
                        var endMark = config.measures[measure][1];
                        if (perfApi.getEntriesByName(startMark).length > 0 && perfApi.getEntriesByName(endMark).length > 0) {
                            perfApi.measure(measure, startMark, endMark);
                            this.measurementIds.push(measure);
                        }
                    }
                }
            }

            //measure per element
            for (var elementHash in this.modeEvents) {
                if (this.modeEvents.hasOwnProperty(elementHash)) {
                    for (var eventType in this.modeEvents[elementHash]) {
                        if (this.modeEvents[elementHash].hasOwnProperty(eventType)) {
                            var marks = this.modeEvents[elementHash][eventType];
                            if (marks) {
                            var measureName = marks['prefix'] + eventType + "_" + elementHash;
                                if (marks['start'] && marks['stop']) {
                                    perfApi.measure(measureName, marks['start'], marks['stop']);
                                    this.measurementIds.push(measureName);
                                } else if (marks['mark']){
                                    perfApi.measure(measureName, marks['mark'], prefix + "measuring");
                                    this.measurementIds.push(measureName);
                                }
                            }
                            //remove marks to prevent sending again on next interval
                            this.modeEvents[elementHash][eventType] = null;
                        }
                    }
                }
            }


            var measureId;
            for (var index = 0; index < this.measurementIds.length; index++) {
                measureId = this.measurementIds[index];
                var measurementsArr = perfApi.getEntriesByName(measureId);
                var measure = measurementsArr[0];
                this.measurements.push(measure);
            }

            // add page level events
            domNavMark = perfApi.getEntriesByType('navigation');
            if (domNavMark.length > 0 && this.firstIterationFlag) {
                domNavMark = domNavMark[0];
                this.measurements.push({
                    name: 'generalMeasure_domInteractive',
                    entryType: "measure",
                    startTime: domNavMark.domInteractive,
                    duration: 0
                });
                this.measurements.push({
                    name: 'generalMeasure_domContentLoadedEventEnd',
                    entryType: "measure",
                    startTime: domNavMark.domContentLoadedEventEnd,
                    duration: 0
                });
                this.measurements.push({
                    name: 'generalMeasure_loadEventEnd',
                    entryType: "measure",
                    startTime: domNavMark.loadEventEnd,
                    duration: 0
                });
                this.measurements.push({
                    name: 'generalMeasure_domComplete',
                    entryType: "measure",
                    startTime: domNavMark.domComplete,
                    duration: 0
                });
                // add page connection data
                this.addPageConnectionMetrics();
            }

            if (this.vitalsCls !== 0) {
                this.measurements.push({
                    name: 'generalMeasure_clsAggAdjusted',
                    entryType: "measure",
                    startTime: performance.now(),
                    duration: this.vitalsCls * 100.0 //Adjusting small number to int64 of the data pipe
                });

                this.measurements.push({
                    name: 'generalMeasure_clsMaxAggAdjusted',
                    entryType: "measure",
                    startTime: performance.now(),
                    duration: this.vitalsClsMax * 100.0 //Adjusting small number to int64 of the data pipe
                });
            }

            this.firstIterationFlag = false;
            this.returnMeasueObj = {};
            var reportObj = {};
            if (this.measurements.length === 0) {
                return;
            }
            else {
                //push fps
                while (this.fpsMeasurements.length > 0) {
                    this.measurements.push(this.fpsMeasurements.pop());
                }
                // push even loop
                while (this.eventLoopMeasurements.length > 0) {
                    this.measurements.push(this.eventLoopMeasurements.pop());
                }
                // log measurments in console
                reportObj.measurements = JSON.stringify(this.measurements);
                reportObj.dict = JSON.stringify(this.modeDictionery);
                this.returnMeasueObj.cv = TRC.version || "";
                if (TRC.networkId) {
                    this.returnMeasueObj.networkId = TRC.networkId;
                }
                if (win.TRCImpl && win.TRCImpl.systemFlags && win.TRCImpl.systemFlags.loaderType) {
                    this.returnMeasueObj.lt = win.TRCImpl.systemFlags.loaderType;
                }
                this.returnMeasueObj.sd = getSessionData();
                this.returnMeasueObj.ri = getRequestId();
                this.returnMeasueObj.vi = getViewId();
                this.returnMeasueObj.data = JSON.stringify(reportObj);
                win.TRCImpl.sendEvent('perf', this.returnMeasueObj, null, false, null, null, shouldUseBeacon);
                this.measurementsCollection = this.measurementsCollection.concat(this.measurements);
                this.measurements = [];

            }
        };

        // add callback for intervention(Heavy Ads) reports
        this.addIntervention = function () {
            var reportingObserver;
            if (typeof window.ReportingObserver === 'function') {
                reportingObserver = new window.ReportingObserver(logIntervention.bind(this, this.logMeasurements.bind(this, true)), {
                    types: ['intervention'],
                    buffered: false
                });
                reportingObserver.observe();
            }
        };

        // mode_name stays for back competability not to break signiture should be removed in next refactor.
        //placement is the new ID
        this.mark = function (name, _now, mode_name, placement, eventType, markType) {
            var hashString = function (str) {
                var hash = 0;
                if (str.length == 0) return hash;
                for (var i = 0; i < str.length; i++) {
                    var char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash;
            };

            var now = _now || perfApi.now();
            var modeHash = hashString(mode_name + placement);
            var markName = prefix + name + ((mode_name || placement) ? '_' + modeHash : '');
            perfApi.mark(markName);
            if (eventType) {
                this.modeDictionery[modeHash] = mode_name + "~~@~~" + placement;
                this.modeEvents[modeHash] = this.modeEvents[modeHash] || {};
                this.modeEvents[modeHash][eventType] = this.modeEvents[modeHash][eventType] || {};

                switch (markType) {
                    case TRC.PerfEvenType.START:
                    case TRC.PerfEvenType.REQ_LEVEL_START:
                        this.modeEvents[modeHash][eventType]['start'] = markName;
                        break;
                    case TRC.PerfEvenType.STOP:
                    case TRC.PerfEvenType.REQ_LEVEL_STOP:
                        this.modeEvents[modeHash][eventType]['stop'] = markName;
                        break;
                    case TRC.PerfEvenType.MARK:
                        this.modeEvents[modeHash][eventType]['mark'] = markName;
                        break;
                }
                if (markType === TRC.PerfEvenType.REQ_LEVEL_STOP || markType === TRC.PerfEvenType.REQ_LEVEL_START)
                {
                    this.modeEvents[modeHash][eventType]['prefix'] = 'reqMeasure_';
                } else {
                    this.modeEvents[modeHash][eventType]['prefix'] = 'generalMeasure_';
                }
            }
            this.perfString = this.perfString + ";" + name + "=" + now;
            return markName;
        };

        window.addEventListener("beforeunload", this.logMeasurements.bind(this));

        var getRequestId = function () {
            // Get any request id in the page
            var getRequestId = win.TRCImpl && win.TRCImpl.getGlobalRequestId.trcBind(win.TRCImpl);
            return getRequestId();
        };

        var getSessionData = function() {
            var getSessionData = win.TRCImpl && win.TRCImpl.getGlobalSessionData.trcBind(win.TRCImpl);
            return getSessionData();
        };

        var getViewId = function () {
            // Get the view id from trk or loader or creating new one
            if (!win.taboola_view_id) {
                win.taboola_view_id = (new Date()).getTime();
            }
            return win.taboola_view_id;
        };


        var Timer = function () {
            this.elapsed = 0;
            this.last = null;
        };

        var logIntervention = function(logFunc) {
            this.mark('intervention-event', null, 'heavyAdIntervention', '', 'heavyAdIntervention', TRC.PerfEvenType.MARK);
            logFunc();
        }

        Timer.prototype = {
            tick: function (now) {
                this.elapsed = ((now - (this.last || now)) / 1000);
                this.last = now;
            },
            fps: function () {
                return Math.round(1 / this.elapsed)
            }
        };

        var timer = new Timer();

        function render(now) {
            win.requestAnimationFrame(render);
            timer.tick(now);
        }

        // (win.requestAnimationFrame && win.requestAnimationFrame(render));
        this.cancelFpsMeasure = function () {
            render = function () {

            }
        };
        this.getTimer = function () {
            return timer;
        };
        this.getrender = function () {
            return render;
        };

        var visCounter = 0;
        var vis = (function () {
            var stateKey,
                eventKey,
                keys = {
                    hidden: "visibilitychange",
                    webkitHidden: "webkitvisibilitychange",
                    mozHidden: "mozvisibilitychange",
                    msHidden: "msvisibilitychange"
                };
            for (stateKey in keys) {
                if (keys.hasOwnProperty(stateKey) && stateKey in document) {
                    eventKey = keys[stateKey];
                    break;
                }
            }
            return function (c) {
                if (c) document.addEventListener(eventKey, c);
                return !document[stateKey];
            }
        })();

        vis(function () {
            if (vis()) {
                (TRC.performance && TRC.performance.mark('windowActiveSTART' + visCounter, null, 'active', visCounter, 'activeTab', TRC.PerfEvenType.START));
                (TRC.performance && TRC.performance.mark('windowActiveSTOP' + visCounter, null, 'active', visCounter, 'activeTab', TRC.PerfEvenType.STOP));
            } else {
                (TRC.performance && TRC.performance.mark('windowInactiveSTART' + visCounter, null, 'inactive', visCounter, 'inactiveTab', TRC.PerfEvenType.START));
                (TRC.performance && TRC.performance.mark('windowInactiveSTOP' + visCounter, null, 'inactive', visCounter, 'inactiveTab', TRC.PerfEvenType.STOP));
            }
            visCounter++;
        });
        this.addIntervention ();
        // trigger measure
        if (config.measureEnable) {
            TRC.__takeMeasureQueue = TRC.__takeMeasureQueue || [];
            var measureTimeToSend = config.measureTimeToSend || 0;
            // set trigger timer/unload
            var measureHandler = this.logMeasurements.bind(this);
            TRC.__takeMeasureQueue.push(measureHandler);
            if (measureTimeToSend == 0) {
                window.addEventListener("beforeunload", TRC.__takeMeasureQueue.pop());
            } else if (TRC.__takeMeasureQueue.length == 1) {
                var currMeasureHandler = TRC.__takeMeasureQueue.pop();
                this.measureTimeout = setTimeout(function () {
                    measureHandler();
                    if (config.measureInterval) {
                        this.measureInterval = setInterval(measureHandler, Math.max(Number(config.measureInterval),10000));
                    }
                }, measureTimeToSend);
            }

            //measuring event loop
            //todo: support configuration or intervals
            setInterval(function () {
                var now = perfApi.now();
                setTimeout(function () {
                    eventLoops.push(perfApi.now() - now);
                }, 0);
            }, eventLoopCheckInterval);

            setInterval(function () {
                var numberOfLoops,
                    avg = 0, max = 0, sum = 0;
                if (eventLoops.length > 0) {
                    numberOfLoops = eventLoops.length;
                    for (var i = 0; i < eventLoops.length; i++) {
                        max = Math.max(max, eventLoops[i]);
                        sum += eventLoops[i];
                    }
                    avg = sum / numberOfLoops;

                    eventLoops = [];//empty samples
                    //report
                    var measureTime = Number(performance.now());
                    if(TRC.performance.eventLoopMeasurements.length <= maxEventLoopToStore) {
                        TRC.performance.eventLoopMeasurements.push({
                            name: 'generalMeasure_ELAVG_' + eventLoopCounter,
                            entryType: "measure",
                            startTime: measureTime,
                            duration: avg
                        });
                        TRC.performance.eventLoopMeasurements.push({
                            name: 'generalMeasure_ELMAX_' + eventLoopCounter,
                            entryType: "measure",
                            startTime: measureTime,
                            duration: max
                        });
                        eventLoopCounter++;
                    }
                }
            }, eventLoopReportInterval);
            // document ready
            if (document.readyState !== "complete") {
                document.addEventListener('readystatechange', function (event) {
                    if (event.target.readyState === "complete") {
                        TRC.performance.measurements.push({
                            name: 'generalMeasure_documentReady',
                            entryType: "measure",
                            startTime: perfApi.now(),
                            duration: 0
                        })
                    }
                });
            }
        }
    }

})(window.performance, window);
function _typeof(obj) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) { return typeof obj; } : function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }, _typeof(obj); }

// based on  https://gist.github.com/Rich-Harris/11010768
(function (win) {
  win.TRC = win.TRC || {};
  var statuses = {
    PENDING: {},
    FULFILLED: {},
    REJECTED: {}
  };

  function PromisePolyFill(callback) {
    var fulfilledHandlers = [],
        rejectedHandlers = [],
        fulfil = makeResolver(statuses.FULFILLED),
        reject = makeResolver(statuses.REJECTED);
    var state = statuses.PENDING,
        result,
        dispatchHandlers;

    function makeResolver(newState) {
      return function (value) {
        if (state !== statuses.PENDING) {
          return;
        }

        result = value;
        state = newState;
        dispatchHandlers = makeDispatcher(state === statuses.FULFILLED ? fulfilledHandlers : rejectedHandlers, result); // dispatch onFulfilled and onRejected handlers asynchronously

        wait(dispatchHandlers);
      };
    }

    try {
      callback(fulfil, reject);
    } catch (error) {
      reject(error);
    }

    var promise = {
      // `then()` returns a PromisePolyFill - 2.2.7
      then: function then(onFulfilled, onRejected) {
        var promise2 = new PromisePolyFill(function (fulfil, reject) {
          var processResolutionHandler = function processResolutionHandler(handler, handlers, forward) {
            // 2.2.1.1
            if (typeof handler === 'function') {
              handlers.push(function (p1result) {
                var x;

                try {
                  x = handler(p1result);
                  resolve(promise2, x, fulfil, reject);
                } catch (err) {
                  reject(err);
                }
              });
            } else {
              // Forward the result of promise1 to promise2, if resolution handlers
              // are not given
              handlers.push(forward);
            }
          }; // 2.2


          processResolutionHandler(onFulfilled, fulfilledHandlers, fulfil);
          processResolutionHandler(onRejected, rejectedHandlers, reject);

          if (state !== statuses.PENDING) {
            // If the promise has resolved already, dispatch the appropriate handlers asynchronously
            wait(dispatchHandlers);
          }
        });
        return promise2;
      }
    };

    promise.catch = function (onRejected) {
      return this.then(null, onRejected);
    };

    return promise;
  }

  PromisePolyFill.all = function (promises) {
    return new PromisePolyFill(function (fulfil, reject) {
      var result = [];
      var pending, i;

      if (!promises.length) {
        fulfil(result);
        return;
      }

      function processPromisePolyFill(i) {
        promises[i].then(function (value) {
          result[i] = value;

          if (! --pending) {
            fulfil(result);
          }
        }, reject);
      }

      pending = i = promises.length;

      while (i--) {
        processPromisePolyFill(i);
      }
    });
  };

  PromisePolyFill.race = function (promises) {
    return new PromisePolyFill(function (fulfil, reject) {
      promises.forEach(function (promise) {
        promise.then(fulfil, reject);
      });
    });
  };

  PromisePolyFill.resolve = function (value) {
    return new PromisePolyFill(function (fulfil) {
      fulfil(value);
    });
  };

  PromisePolyFill.reject = function (reason) {
    return new PromisePolyFill(function (fulfil, reject) {
      reject(reason);
    });
  };

  function wait(callback) {
    setTimeout(callback, 0);
  }

  function makeDispatcher(handlers, result) {
    return function () {
      var handler;

      while (handler = handlers.shift()) {
        handler(result);
      }
    };
  }

  function resolve(promise, x, fulfil, reject) {
    // PromisePolyFill Resolution Procedure
    var then; // 2.3.1

    if (x === promise) {
      throw new TypeError('A promise\'s fulfillment handler cannot return the same promise');
    } // 2.3.2


    if (x instanceof PromisePolyFill) {
      x.then(fulfil, reject);
    } else {
      // 2.3.3
      // eslint-disable-next-line no-lonely-if
      if (x && (_typeof(x) === 'object' || typeof x === 'function')) {
        try {
          // eslint-disable-next-line prefer-destructuring
          then = x.then; // 2.3.3.1
        } catch (e) {
          reject(e); // 2.3.3.2

          return;
        } // 2.3.3.3


        if (typeof then === 'function') {
          // eslint-disable-next-line no-inner-declarations
          var resolvePromisePolyFill = function resolvePromisePolyFill(y) {
            if (called) {
              return;
            }

            called = true;
            resolve(promise, y, fulfil, reject);
          };

          var called;

          var rejectPromisePolyFill = function rejectPromisePolyFill(r) {
            if (called) {
              return;
            }

            called = true;
            reject(r);
          };

          try {
            then.call(x, resolvePromisePolyFill, rejectPromisePolyFill);
          } catch (e) {
            if (!called) {
              // 2.3.3.3.4.1
              reject(e); // 2.3.3.3.4.2

              called = true;
            }
          }
        } else {
          fulfil(x);
        }
      } else {
        fulfil(x);
      }
    }
  }

  win.TRC.PromisePolyFill = PromisePolyFill;
})(window);
TRC.loaderUtils = {
  isNativeFunction: function isNativeFunction(fn) {
    return /\{\s*\[native code\]\s*\}/.test("".concat(fn));
  },
  Promise: typeof Promise !== 'undefined' ? Promise : TRC.PromisePolyFill
};
(function (win) {

    win.TRC = win.TRC || {};
    /**
     * This function is written in order to avoid blocking the main thread.
     * It behaves differently according to the publishers' configuration
     * The publisher can choose whether to optimize by TBT, INP or TTFI (run as fast as possible)
     * @param faderType - tbt, inp or none
     * @param faderPolyfill - whether to use a polyfill in case scheduler.postTask is not supported
     * @returns {*|TRC.PromisePolyFill}
     */
    TRC.Fader = function Fader(faderType, faderPolyfill) {
        if (TRC.sendTaskToFader) {
            return TRC.sendTaskToFader;
        }
        const OptimizationFaderType = {
            NONE: 'none',
            TBT: 'tbt',
            INP: 'inp'
        };
        const SchedulerTaskPriority = {
            USER_BLOCKING: 'user-blocking',
            USER_VISIBLE: 'user-visible',
            BACKGROUND: 'background'
        };
        if (!faderType) {
            faderType = OptimizationFaderType.TBT;
        }
        TRC.sendTaskToFader = (task, isBlocker) => {
            const isTBT = faderType === OptimizationFaderType.TBT;
            if (isTBT) {
                return runAsPostTask(task, isBlocker);
            }

            const isINP = faderType === OptimizationFaderType.INP
                && TRC.loaderUtils.isNativeFunction(win.Scheduling) && navigator.scheduling.isInputPending
                && navigator.scheduling.isInputPending();
            if (isINP) {
                return runAsPostTask(task, isBlocker);
            }

            return runImmediately(task);
        };
        return TRC.sendTaskToFader;

        function isPostTaskSupported() {
            return TRC.loaderUtils.isNativeFunction(window.Scheduler) && window.scheduler && window.scheduler.postTask;
        }

        function runAsPostTask(task, isBlocker = true) {
            if (isPostTaskSupported()) {
                const priority = isBlocker ? SchedulerTaskPriority.USER_BLOCKING : SchedulerTaskPriority.BACKGROUND;
                return window.scheduler.postTask(task, {priority});
            }
            if (faderPolyfill) {
                return new TRC.loaderUtils.Promise(resolve => {
                    window.setTimeout(() => {
                        resolve(task());
                    }, 0);
                });
            }
            return runImmediately(task);
        }

        function runImmediately(task) {
            return new TRC.loaderUtils.Promise(resolve => {
                resolve(task());
            });
        }
    };
}(window));(function (win) {

    win.TRC = win.TRC || {};

    win.TRC.inflate = {
        STYLE: '__style__',
        COMMON: '__common__',
        KEYS: '__keys__',
        getModeCustom(modeName, modeCustom) {
            const exp = `\\/\\*\\ss-split-${modeName}\\s\\*\\/[^]*\\*\\se-split-${modeName}\\s\\*\\/`;
            const regex = new RegExp(exp, 'g');
            const result = modeCustom.match(regex);
            return result ? result[0] : null;
        },
        inflateObject(commonInstance, instance) {
            const inflatedObject = {};
            const keys = this.inflateValue(this.KEYS, commonInstance, instance);
            keys.forEach(key => {
                inflatedObject[key] = this.inflateValue(key, commonInstance, instance);
            });
            return inflatedObject;
        },
        inflateValue(key, commonInstance, instance) {
            let value = instance[key];
            if (typeof value === 'undefined') {
                value = commonInstance[key];
            }
            return value;
        },
        inflateStyle(mode, style) {
            let buffer = '';

            Object.keys(style).forEach(key => {
                const value = style[key];
                let selector = '';

                key.split(',').forEach(keyPart => {
                    if (selector !== '') selector += ',';
                    selector += `.${mode} ${keyPart}`;
                });

                buffer += `${selector}{${value}}`;

            });

            return buffer;
        },
        getConfig(config) {
            // mobile safari has and issue with css lite inject
            const cssLiteInject = config.global['enable-mode-injection'] && !(win.navigator && typeof win.navigator.userAgent === 'string' && (/(iPhone|iPad)(?=.*AppleWebKit)(?!.*CriOS)/i.test(win.navigator.userAgent)));
            const includeModes = config && config.modes;
            if (!includeModes) {
                return config;
            }
            const {modes, global} = config,
                {style} = global,
                commonMode = modes[this.COMMON];

            if (!commonMode) {
                return;
            }

            const canMark = window.performance && typeof window.performance.mark === 'function';

            if (canMark) {
                window.performance.mark('tbl_inflate_start');
            }

            const inflatedModes = {};
            let inflatedStyle = style.rtl;
            const modeInflateStepList = [];
            const faderType = TRC.__optFad
                || config.global.perf_opt_fader;
            const faderPolyfill = typeof TRC.__optFadPo === 'undefined' ? config.global.enable_opt_fader_poly || false : TRC.__optFadPo;
            const sendTaskToFader = TRC.Fader(faderType, faderPolyfill);
            const STEP_BATCH_LENGTH = 10;
            Object.keys(modes).forEach(modeName => {
                if (modeName === this.COMMON) {
                    return;
                }
                modeInflateStepList.push(() => {
                    const mode = modes[modeName];

                    inflatedModes[modeName] = this.inflateObject(commonMode, mode);
                    if (cssLiteInject) {
                        inflatedModes[modeName][this.STYLE] = mode[this.STYLE] || commonMode[this.STYLE];
                        if (config.global['enable-custom-injection']) {
                            inflatedModes[modeName].mode_custom = this.getModeCustom(modeName, style.mode_custom) || '';
                        }
                    } else {
                        inflatedStyle += this.inflateStyle(modeName, this.inflateObject(commonMode[this.STYLE], mode[this.STYLE]));
                    }
                });
            });
            const runNextInflateSteps = () => {
                if (modeInflateStepList.length === 0) {
                    return TRC.loaderUtils.Promise.resolve();
                }
                const steps = modeInflateStepList.splice(0, STEP_BATCH_LENGTH);
                return sendTaskToFader(() => {
                    steps.forEach(step => step());
                })
                    .then(runNextInflateSteps);
            };

            return runNextInflateSteps()
                .then(() => {
                    if (!cssLiteInject) {
                        inflatedStyle += style.custom;
                        inflatedStyle += style.mode_custom;
                        global.style = inflatedStyle;
                    } else {
                        inflatedModes[this.COMMON] = commonMode;
                    }
                    config.modes = inflatedModes;

                    if (canMark) {
                        window.performance.mark('tbl_inflate_end');
                    }
                    return config;

                });
        }
    };
}(window));/*
 * Supported API:
 * _taboola.push({... other page parameters });
 * _taboola.push({notify:"notification", ... extra parameters });
 * _taboola.push({mode: "modename", tracking_codes : { utm_source ... } ... other mode parameters});
 * or
 * _taboola.push([{mode: "mode1",container:"a",...},{mode:"mode2",container:"b",...}]);
 */

(function (win, doc) {
    // set up our name space - this is the one time setup done in the loader. Do not copy or duplicate
    if (win.TRC && win.TRC.utm) {
        return;
    } else if (win.TRC) {
        TRC.utm = []; //utm and loader initialization flag
    } else {
        TRC = {utm: []};
    }
    var queueName = "_taboola";
    win[queueName] = win[queueName] || [];
    var bakerConfig = {"modes":{"rbox-blended":{"__style__":{}},"__common__":{"syndicated-attribution-tooltip":"","expand-animation-duration":1000,"loading-animation-url":"hide","pager-style-active-image":"","recommendationReel-is-min-adx":false,"vignette-openButtonFontFamily":"","player-detail-order":"title,description","slider-scroll-ref-element":function () { return window; },"slider-close-btn-color":"#FFF","slider-slide-from":"bottom","shade-scroll":false,"pager-button-inactive-image":"","has-thumbs-image-lazy-load":false,"visibility-constraints":{},"responsive-rules":null,"format-description":'%s',"vignette-xButtonSize":"","format-x-days-ago":false,"gam-allow-trc-ads":false,"player-container-id":"trc_Embed_Container_Id","image-min-width":100,"organic-static-text-position":"bottom-left","before-detail-order":"","slider-close-btn-font-size":"30px","read-more-box-selector":"","widget-creator-layout":"autowidget-template","format-external-data":'%s',"recommendationReel-min-adx-line-color":"#2abfd5","player-thumbnail-height":"200","emblem-position":"top-left","header-right":"No Header","gif-url-prefix":null,"slider-close-btn-size":"24px","ctaWidget":true,"vignette-xButtonBackgroundColor":"","recommendationReel-interval":7,"vignette-openButtonText":"","storyWidget-storyWidget-story-num-title-lines":3,"branding-separator":"|","format-duration":'%s',"after-visible":function(data) {},"vignette-closeButtonBackgroundColor":"","enable-prioritized-layout":false,"rtb-image-url-prefix":null,"header-icon":"NONE","image-dpr-factor":2,"vignette-closeButtonFontColor":"","item-renderer":function(box,data) { if (typeof window.trc_itemRenderer == 'function') window.trc_itemRenderer(document.createElement('div'),data, false);},"read-more-minimized-size":800,"use-browser-line-clamp":true,"slider":false,"item-data-filter":function(data) {},"vignette-openButtonBackgroundColor":"","recommendationReel-splash-screen":false,"vignette-backgroundOpacity":0.8,"auto-advance":"-1","recommendationReel-wait-for-video-demand":false,"image-min-dimension":100,"auto-scroll":"none","recommendationReel-num-title-lines":3,"format-category":'%s',"auto-advance-animation":"down","format-syndicator":function(s){ return s; },"vignette-xButtonPosition":"","slider-transition-delay":200,"popup-custom-url":"","mode-start":function(data) {},"storyWidget":false,"recommendationReel-slider-below-only":false,"adchoice-position":"none","disclosure-link-text-sponsored":"Sponsored Links","mode-has-userx":true,"slider-background-color":"#666","image-size-round":20,"detail-order-ad":"title","style-template":"Light","thumbnail-width":"75","min-width-for-disclosure":225,"detail-order":"title,description","image-max-dimension":1500,"format-published-date":function(d){return this.dateFormatISO(d, false);},"mode-is-responsive":false,"expandable":false,"remove-url-playvideo-behavior":false,"expand-animation-max-height":1000,"responsive-extra-columns":1,"title":"Related Videos","published-date-position":"standalone","header-icon-url":"","thumbnail-position-ad":"inherit","format-title":'%s',"vignette-closeButtonFontSize":"","widget-creator-revision":"-1","hide-attribution-when-no-place":false,"pager-type-style":"numbers","impl-class":"TRCRBox","vignette-closeButtonText":"","has-expand-animation":false,"disclosure-link-text-organic":"","recommendationReel-slider-start-from-slider":false,"syndicated-attribution":"","image-lazy-load-space":200,"sponsored-location":"top","recommendationReel-min-adx-cta-text":"","__keys__":['component-id','tabbed','header','expandable','list-size','orientation','navigation-type','auto-scroll','loading-animation-url','thumbnail-width','thumbnail-height','format','detail-order','icons','format-number','change-url','list-suffix','item-renderer','title','format-title','format-duration','format-description','format-category','format-uploader','format-views','format-rating','format-published-date','sponsored-location','thumbnail-position','color-scheme','pager-button-style','pager-position','pager-type-style','template','pager-button-location','pager-button-active-image','pager-button-inactive-image','pager-button-hover-image','pager-style-active-image','pager-style-inactive-image','pager-style-hover-image','lightbox-display-title','detail-order-ad','layout-template','style-template','attribution-position','shade-scroll','attribution-text','required-attributes','auto-advance-animation','auto-advance','format-external-data','item-data-filter','gam-allow-trc-ads','thumbnail-position-ad','impl-class','player-embed-code','player-container-id','render-player-info','player-thumbnail-width','player-thumbnail-height','player-detail-order','use-cdn-recommendations','syndicated-attribution','syndicated-attribution-tooltip','syndicated-attribution-position','detail-order-syndicated','format-syndicator','syndicated-static-text','syndicated-static-text-position','quantcast-label','cyclical-paging','after-visible','link-target','auto-syndicated-attribution','remove-url-playvideo-behavior','auto-size','auto-size-rules','rows','widget-creator-layout','widget-creator-revision','details-inline-with-title','mode-is-responsive','responsive-extra-columns','responsive-rules','image-lazy-load-space','has-image-lazy-load','use-css-important','image-url-prefix','image-size-factor','image-min-width','image-size-round','image-max-dimension','image-min-dimension','mode-has-userx','min-width-for-disclosure','min-width-for-attribution','hide-disclosure-when-no-place','hide-attribution-when-no-place','disclosure-link-text-sponsored','disclosure-link-text-hybrid','disclosure-link-text-organic','disclosure-position','header-right','use-browser-line-clamp','use-dpr-images','slider','slider-slide-from','slider-min-effective-scroll-size','slider-transition-duration','slider-transition-delay','slider-background-color','slider-close-btn-font-size','slider-close-btn-size','slider-close-btn-color','slider-scroll-ref-element','slider-z-index','mode-adc-config','images-radius','visibility-constraints','ios-sc-link-target-mode','has-expand-animation','expand-animation-duration','expand-animation-max-height','read-more-config','enable-read-more','mode-has-adchoice','adchoice-large','adchoice-position','adchoice-target-url','read-more-box-selector','read-more-threshold','read-more-minimized-size','read-more-caption','mode-start','smart-ellipsis','tokenize-strategy','rtb-image-url-prefix','image-dpr-factor','image-allowed-ratio-diff','popup-custom-url','carousel-min-items','header-icon-url','before-detail-order','title-icon-url','before-detail-order-syndicated','header-icon','title-icon','has-thumbs-image-lazy-load','thumbs-image-lazy-load-margins','read-more-cutoff-from-type','read-more-anchor-selector','read-more-cutoff-length-type','read-more-cutoff-length-from-anchor-element','read-more-mode-devices','branding-separator','disclosure-alignment','p-video-overlay','gif-url-prefix','storyWidget','storyWidget-story-interval','organic-static-text-position','organic-show-static-text','organic-static-text','widget-theme-type','storyWidget-story-num-title-lines','format-x-days-ago','storyWidget-storyWidget-story-interval','storyWidget-storyWidget-story-num-title-lines','published-date-position','enable-category-card','emblem-position','organic-tracking-params','ctaWidget','mode-enable-feed-view','storyWidget-recommendation-reel-enable-text-under-slide-in','recommendationReel-enable-text-under-slide-in','recommendationReel-num-title-lines','recommendationReel-interval','recommendationReel','enable-title-icon-on-sc','recommendationReel-slider-navigation-text','recommendationReel-slider-text-under-slide-in-only','recommendationReel-slider-below-only','recommendationReel-slider-position','recommendationReel-enable-slider','recommendationReel-slide-below-first-item-only','recommendationReel-slider-start-from-slider','enable-prioritized-layout','nextUpWidget-static-ui','vignette-xButtonPosition','vignette-xButtonShow','vignette-xButtonSize','vignette-backgroundColor','vignette-backgroundOpacity','vignette-xButtonBGColor','vignette-xButtonColor','vignette-screenBackgroundColor','vignette-screenBackgroundOpacity','vignette-xButtonBackgroundColor','vignette-closeButtonFontFamily','vignette-closeButtonText','vignette-closeButtonFontSize','vignette-openButtonText','vignette-openButtonBackgroundColor','vignette-closeButtonPadding','vignette-closeButtonFontColor','vignette-openButtonFontColor','vignette-buttonsTopSpacing','vignette-openButtonHoverColor','vignette-openButtonPadding','vignette-closeButtonHoverColor','vignette-openButtonFontSize','vignette-openButtonFontFamily','vignette-closeButtonBackgroundColor','recommendationReel-is-videoreel','recommendationReel-auto-pause','recommendationReel-is-min-adx','recommendationReel-min-adx-cta-text','recommendationReel-wait-for-video-demand','recommendationReel-splash-screen','recommendationReel-min-adx-progress-color','recommendationReel-min-adx-line-color'],"organic-static-text":"MOST POPULAR","icons":false,"thumbnail-position":"start","format-views":function(n){ return 'Views: '+this.formatNumber(n, false);},"read-more-mode-devices":"","storyWidget-story-num-title-lines":3,"vignette-buttonsTopSpacing":"","recommendationReel-slider-text-under-slide-in-only":true,"image-url-prefix":null,"read-more-cutoff-length-from-anchor-element":30,"syndicated-static-text":"Sponsored","required-attributes":"none","change-url":function(url){return url;},"syndicated-static-text-position":"top-right","pager-button-location":"pager","nextUpWidget-static-ui":false,"recommendationReel-enable-text-under-slide-in":false,"recommendationReel-slide-below-first-item-only":false,"mode-adc-config":null,"details-inline-with-title":"","thumbnail-height":"55","vignette-xButtonColor":"","auto-size":false,"vignette-screenBackgroundColor":"","disclosure-alignment":"left","adchoice-large":false,"layout-template":"Horizontal 4","vignette-xButtonShow":true,"mode-enable-feed-view":false,"storyWidget-story-interval":7,"ios-sc-link-target-mode":null,"read-more-config":null,"thumbs-image-lazy-load-margins":"600px 1500px","recommendationReel-slider-navigation-text":"Read more","read-more-caption":"","template":"Default","pager-position":"start","format-uploader":'User: %s',"vignette-closeButtonFontFamily":"","disclosure-position":"top","image-size-factor":1.2,"title-icon":"NONE","lightbox-display-title":true,"has-image-lazy-load":false,"navigation-type":"scrolling","vignette-openButtonHoverColor":"","cyclical-paging":false,"tokenize-strategy":"word","adchoice-target-url":"","vignette-backgroundColor":"#fff","disclosure-link-text-hybrid":"Promoted Links","vignette-closeButtonPadding":"","recommendationReel-slider-position":"bottom","pager-button-active-image":"","player-thumbnail-width":"75","enable-category-card":false,"color-scheme":"White","slider-z-index":2500000,"slider-transition-duration":600,"use-css-important":false,"smart-ellipsis":false,"storyWidget-storyWidget-story-interval":7,"pager-button-hover-image":"","vignette-openButtonPadding":"","render-player-info":false,"recommendationReel-enable-slider":false,"mode-has-adchoice":true,"player-embed-code":function(){return '';},"image-allowed-ratio-diff":0.029,"use-cdn-recommendations":false,"list-size":10,"enable-read-more":false,"auto-size-rules":[{"minWc":120,"maxWc":249,"minWsRange":8,"maxWsRange":8,"n":1},{"minWc":250,"maxWc":379,"minWsRange":8,"maxWsRange":9,"n":2},{"minWc":380,"maxWc":609,"minWsRange":8,"maxWsRange":10,"n":3},{"minWc":610,"maxWc":749,"minWsRange":8,"maxWsRange":11,"n":4},{"minWc":750,"maxWc":1029,"minWsRange":7,"maxWsRange":11,"n":5},{"minWc":1030,"maxWc":1419,"minWsRange":6,"maxWsRange":11,"n":6},{"minWc":1420,"maxWc":1729,"minWsRange":6,"maxWsRange":12,"n":7},{"minWc":1730,"maxWc":1920,"minWsRange":6,"maxWsRange":13,"n":8}],"carousel-min-items":1.33,"p-video-overlay":false,"attribution-text":"<span>by<span style=\"font-size:12px;\">Taboola</span></span>","storyWidget-recommendation-reel-enable-text-under-slide-in":false,"format":{ 'views': 'Views: %s', 'uploader': 'By: %s','duration': 'Duration: %s','rating': 'Rating: %s'},"auto-syndicated-attribution":true,"pager-style-hover-image":"","syndicated-attribution-position":"bottom-right","attribution-position":"bottom","pager-style-inactive-image":"","min-width-for-attribution":325,"header":"Videos","read-more-cutoff-length-type":"BELOW","tabbed":false,"read-more-threshold":1100,"recommendationReel":false,"format-number":function(num){var out="",m;while(num.length>3&&(m=num.match(/\d{3}\s*$/))){out=m.toString().replace(/\s+/,"")+","+out;num=num.replace(/\d{3}\s*$/,"", false);}out=num+","+out;return out.replace(/,$/,"");},"vignette-openButtonFontSize":"","vignette-screenBackgroundOpacity":0.8,"images-radius":"0","recommendationReel-is-videoreel":false,"vignette-openButtonFontColor":"","organic-show-static-text":false,"hide-disclosure-when-no-place":false,"pager-button-style":"<span class=\"pager-cont\">&laquo;</span>|<span class=\"pager-cont\">&raquo;</span>","link-target":"normal","organic-tracking-params":null,"component-id":"rbox-blended","list-suffix":function(internalc, myorigin) {},"detail-order-syndicated":"branding,title","title-icon-url":"","read-more-cutoff-from-type":"ARTICLE","orientation":"vertical","quantcast-label":"","recommendationReel-min-adx-progress-color":"#2abfd5","vignette-closeButtonHoverColor":"","vignette-xButtonBGColor":"#000","enable-title-icon-on-sc":false,"rows":1,"format-rating":'Rating: %s',"read-more-anchor-selector":"","before-detail-order-syndicated":"","slider-min-effective-scroll-size":20,"recommendationReel-auto-pause":false,"use-dpr-images":true,"widget-theme-type":"DEFAULT","__style__":{"":"width:300px;_width:300px;border-width:0px;border-style:solid solid solid solid;border-color:#000000;padding:0;border-radius:0;-moz-border-radius:0;-webkit-border-radius:0;box-shadow:none;","vignette":"xButtonColor:#fff;backgroundColor:#fff;backgroundOpacity:0.8;xButtonBGColor:#000;",".playerCube .video-external-data":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".tbl-reco-reel-slider":"z-index:99999;margin:initial;top:50%;",".trc_lightbox_overlay":"background-color:#000000;opacity:0.70;filter:alpha(opacity=70);",".tbl-recommendation-reel .tbl-text-under-branding-background":"background-color:#EBEBEB;","div.syndicatedItem:hover, div.syndicatedItem.videoCube_hover":"background-color:transparent;",".playerCube div.videoCube:hover, div.videoCube_hover":"background-color:transparent;",".trc_pager_prev:hover, .trc_pager_next:hover":"color:#6497ED;",".trc_rbox_border_elm":"border-color:darkgray;",".syndicatedItem .video-views":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".syndicatedItem .video-category":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".tbl-vignette-close-btn-wrp":"height:15;background:#000;",".videoCube .video-label-box":"margin-left:81px;margin-right:0px;",".syndicatedItem .sponsored":"color:#9C9A9C;font-size:9px;font-weight:normal;text-decoration:none;",".pager_disabled":"color:#7d898f;",".playerCube .video-category":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".syndicatedItem .video-uploader":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".videoCube.thumbnail_start .thumbBlock_holder":"width:40%;_width:40%;",".playerCube .video-uploader":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".video-uploader":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".trc_sponsored_overlay":"background-color:black;",".syndicatedItem .video-external-data":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".trc_rbox_header":"font-family:Arial, Helvetica, sans-serif;font-size:16px;font-weight:bold;text-decoration:none;color:black;border-width:0;background:transparent;border-style:none none solid none;border-color:#D6D5D3;padding:0;",".syndicatedItem .video-rating":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".videoCube.vertical":"border-style:solid none none none;",".trc_pager_unselected":"color:#7d898f;",".video-rating":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".video-published-date":"font-size:10px;font-weight:normal;text-decoration:none;color:black;display:inherit;",".syndicatedItem":"background-color:transparent;",".syndicatedItem .video-duration-detail":"color:black;font-size:10px;font-weight:normal;text-decoration:none;",".playerCube .videoCube.horizontal":"border-style:none none none none;",".videoCube.syndicatedItem .thumbnail-overlay":"background-image:null;background-position:5% 5%;",".videoCube.syndicatedItem.vertical":"border-style:solid none none none;",".sponsored":"font-size:9px;font-weight:normal;text-decoration:none;color:#9C9A9C;",".videoCube.syndicatedItem .thumbBlock":"border-color:darkgray;border-width:0px;",".videoCube.syndicatedItem .thumbBlock .static-text":"text-align:left;background-color:black;display:block;color:white;font-size:10px;font-weight:normal;text-decoration:none;font-family:Arial, Helvetica, sans-serif;",".videoCube.thumbnail_start.trc-split-label .trc-pre-label":"width:30%;_width:30%;",".video-category":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".thumbnail-emblem":"background-position:5% 5%;width:35;_width:35;height:35;",".tbl-vignette-background-screen":"background-color:#fff;opacity:0.8;filter:alpha(opacity=80);",".syndicatedItem .video-description":"max-height:2.2em;*height:2.2em;color:black;font-family:Arial, Helvetica, sans-serif;font-size:10px;font-weight:normal;line-height:11px;text-decoration:none;",".tbl-cta-style .cta-button:hover":"color:inherit;border-color:#999990;",".playerCube .video-published-date":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".videoCube:hover .thumbnail-overlay, .videoCube_hover .thumbnail-overlay":"background-image:null;",".video-label-box.trc-pre-label":"height:auto;",".video-label,.sponsored,.sponsored-url":"font-family:Arial, Helvetica, sans-serif;",".videoCube.thumbnail_start .trc-pre-label":"width:60%;_width:60%;",".syndicatedItem .video-title":"max-height:2.58em;*height:2.58em;color:black;font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:17.5px;font-weight:bold;text-decoration:none;padding:0;",".playerCube:hover .thumbnail-overlay, .playerCube_hover .thumbnail-overlay":"background-image:null;",".videoCube.thumbnail_start.trc-split-label .trc-main-label":"width:30%;_width:30%;",".videoCube":"width:auto;_width:auto;background-color:transparent;border-width:1px;border-color:#D6D5D3;padding:3px;height:auto;margin-left:0px;margin-top:0px;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;border-style:none;",".sponsored-default .video-description":"max-height:2.2em;*height:2.2em;",".tbl-vignette-attribution":"color:#6B6666;font-size:15px;",".playerCube .video-description":"font-family:Arial, Helvetica, sans-serif;font-size:10px;line-height:11px;font-weight:normal;text-decoration:none;max-height:2.2em;*height:2.2em;color:black;",".playerCube .videoCube .video-label-box":"margin-left:81px;margin-right:0px;",".videoCube.syndicatedItem .thumbBlock .branding":"text-align:left;background-color:transparent;display:block;left:0px;color:black;font-size:10px;font-weight:normal;text-decoration:none;font-family:Arial, Helvetica, sans-serif;background-image:null;","div.videoCube:hover, div.videoCube_hover":"background-color:transparent;",".videoCube .story-widget.story-widget-text-under .tbl-ui-line":"background-color:#333333;",".videoCube .sponsored":"margin-top:-7px;",".trc_pager_pages div":"font-size:12px;font-weight:normal;text-decoration:none;",".sponsored-url":"font-size:9px;font-weight:bold;text-decoration:underline;color:green;",".playerCube .video-title":"font-family:Arial, Helvetica, sans-serif;text-decoration:none;font-size:14px;line-height:17.5px;font-weight:bold;max-height:2.58em;*height:2.58em;color:black;",".videoCube.syndicatedItem .video-label-box":"margin-left:0px;",".trc_rbox_header_icon_img":"margin:0px;height:18px;",".tbl-recommendation-reel .tbl-text-under-title-background":"background-color:#EBEBEB;",".tbl-recommendation-reel .tbl-ui-line":"background-color:#333333;",".videoCube.syndicatedItem.horizontal":"border-style:none none none solid;",".videoCube .thumbBlock .static-text":"font-weight:normal;font-family:Arial, Helvetica, sans-serif;text-decoration:none;font-size:11px;background-color:#a30202;display:block;color:#ffffff;text-align:left;",".video-title":"font-family:Arial, Helvetica, sans-serif;font-size:14px;line-height:17.5px;font-weight:bold;max-height:2.58em;*height:2.58em;color:black;text-decoration:none;",".playerCube .video-rating":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".syndicatedItem .branding":"color:black;font-size:10px;font-weight:normal;text-decoration:none;font-family:Arial, Helvetica, sans-serif;background-image:null;text-align:left;",".trc_pager_selected":"color:#0056b3;",".videoCube.syndicatedItem":"background-color:transparent;border-color:#D6D5D3;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;border-width:1px;border-style:none;",".videoCube .video-label-box.trc-pre-label":"margin:0;",".branding div.logoDiv":"font-family:inherit;",".trc_rbox_div":"width:auto;_width:99%;height:410px;border-width:1px;padding:0;",".playerCube .video-views":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".trc_pager div":"font-family:serif;",".syndicatedItem .video-label-box.trc-pre-label":"height:auto;","recommendationReel":"min-adx-line-color:#2abfd5;min-adx-progress-color:#FFF;",".videoCube.horizontal":"border-style:none none none solid;","div.trc_pager_pages div:hover":"color:#6497ED;",".pager_enabled":"color:#0056b3;",".playerCube .thumbnail-overlay":"background-image:null;background-position:5% 5%;",".videoCube .thumbnail-overlay":"background-image:null;background-position:5% 5%;",".playerCube .videoCube .video-duration":"display:block;left:36px;",".syndicatedItem .video-published-date":"color:black;font-size:10px;font-weight:normal;text-decoration:none;display:inherit;",".syndicatedItem .sponsored-url":"color:green;font-size:9px;font-weight:bold;text-decoration:underline;",".playerCube .videoCube .thumbBlock":"border-width:0px;border-color:darkgray;",".playerCube .video-label-box":"text-align:left;","div.sponsored-default:hover, div.sponsored-default.videoCube_hover":"background-color:inherit;",".videoCube .story-widget.story-widget-text-under .tbl-text-under-title-background":"background-color:#EBEBEB;",".video-external-data":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".trc_pager_prev,.trc_pager_next":"font-size:12px;font-weight:normal;text-decoration:none;",".videoCube .thumbBlock":"border-width:0px;border-color:darkgray;",".videoCube.syndicatedItem .video-duration":"display:block;left:36px;",".sponsored-default .video-title":"max-height:2.58em;*height:2.58em;",".branding":"color:black;font-size:10px;font-weight:normal;text-decoration:none;font-family:Arial, Helvetica, sans-serif;background-image:null;text-align:left;",".sponsored-default":"background-color:#F7F6C6;","__keys__":['.video-title','.video-description','.trc_rbox_div','.videoCube .video-duration','.videoCube .video-label-box','.video-label,.sponsored,.sponsored-url','.trc_rbox_header','.sponsored-url','.sponsored','.video-category','.video-duration-detail','.video-rating','.video-uploader','.video-views','.video-published-date','.sponsored-default .video-title','.sponsored-default .video-description','.videoCube','div.videoCube:hover, div.videoCube_hover','.sponsored-default','div.sponsored-default:hover, div.sponsored-default.videoCube_hover','.videoCube .thumbnail-overlay','.videoCube:hover .thumbnail-overlay, .videoCube_hover .thumbnail-overlay','.trc_rbox_border_elm','.videoCube .thumbBlock','div.videoCube:hover .thumbBlock','.pager_enabled','.trc_pager_counter','.pager_disabled','.trc_pager_prev:hover, .trc_pager_next:hover','.trc_pager_selected','.trc_pager_unselected','div.trc_pager_pages div:hover','.trc_lightbox_overlay','.video-label-box','.trc_sponsored_overlay','.thumbnail-emblem','.videoCube .sponsored','','.videoCube.vertical','.videoCube.horizontal','.trc_pager_prev,.trc_pager_next','.trc_pager_pages div','.video-external-data','.trc_pager div','.playerCube .thumbnail-overlay','.playerCube:hover .thumbnail-overlay, .playerCube_hover .thumbnail-overlay','.playerCube .videoCube','.playerCube .videoCube.horizontal','.playerCube .videoCube .video-label-box','.playerCube .video-duration-detail','.playerCube .video-external-data','.playerCube .video-label-box','.playerCube .video-published-date','.playerCube .video-category','.playerCube .video-description','.playerCube .videoCube .video-duration','.playerCube .videoCube .thumbBlock','.playerCube .video-rating','.playerCube .video-uploader','.playerCube .video-views','.playerCube .video-title','.playerCube div.videoCube:hover, div.videoCube_hover','.whatsThisSyndicated','div.syndicatedItem:hover, div.syndicatedItem.videoCube_hover','div.syndicatedItem:hover .thumbBlock','.videoCube.syndicatedItem','.videoCube.syndicatedItem.horizontal','.videoCube.syndicatedItem .thumbBlock','.videoCube.syndicatedItem .thumbnail-overlay','.videoCube.syndicatedItem.vertical','.videoCube.syndicatedItem .video-duration','.videoCube.syndicatedItem .video-label-box','.syndicatedItem','.syndicatedItem .video-description','.syndicatedItem .video-title','.syndicatedItem .sponsored','.syndicatedItem .sponsored-url','.syndicatedItem .video-category','.syndicatedItem .video-duration-detail','.syndicatedItem .video-external-data','.syndicatedItem .video-published-date','.syndicatedItem .video-rating','.syndicatedItem .video-uploader','.syndicatedItem .video-views','.syndicatedItem .branding','.videoCube.syndicatedItem .thumbBlock .branding','.videoCube.syndicatedItem .thumbBlock .static-text','.videoCube.thumbnail_start .thumbBlock_holder','.trc_rbox_header_icon_img','.video-icon-img','.video-label-box.trc-pre-label','.syndicatedItem .video-label-box.trc-pre-label','.videoCube.thumbnail_start .trc-pre-label','.videoCube.thumbnail_start.trc-split-label .trc-main-label','.videoCube.thumbnail_start.trc-split-label .trc-pre-label','.videoCube .video-label-box.trc-pre-label','.branding','.branding .logoDiv a span','.branding div.logoDiv','.videoCube .thumbBlock .static-text','.tbl-cta-style .cta-button','.tbl-cta-style .cta-button:hover','.videoCube .story-widget.story-widget-text-under .tbl-text-under-title-background','.videoCube .story-widget.story-widget-text-under .tbl-ui-line','.tbl-recommendation-reel .tbl-text-under-branding-background','.tbl-recommendation-reel .tbl-text-under-title-background','.tbl-recommendation-reel .tbl-ui-line','.tbl-reco-reel-slider','.tbl-vignette-background-screen','.tbl-vignette-attribution','vignette','.tbl-vignette-close-btn-wrp','recommendationReel'],".playerCube .videoCube":"background-color:transparent;border-color:#D6D5D3;border-width:1px;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;margin-left:0px;margin-top:0px;padding:3px;",".branding .logoDiv a span":"color:inherit;font-size:inherit;",".video-label-box":"text-align:left;",".video-description":"font-family:Arial, Helvetica, sans-serif;font-size:10px;line-height:11px;font-weight:normal;max-height:2.2em;*height:2.2em;color:black;text-decoration:none;",".videoCube .video-duration":"left:36px;display:block;","div.syndicatedItem:hover .thumbBlock":"border-color:inherit;",".trc_pager_counter":"color:#000000;",".whatsThisSyndicated":"font-family:Arial, Verdana, sans-serif;font-size:9px;font-weight:normal;color:black;text-decoration:none;padding:0;",".playerCube .video-duration-detail":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".video-duration-detail":"font-size:10px;font-weight:normal;text-decoration:none;color:black;","div.videoCube:hover .thumbBlock":"border-color:inherit;",".video-icon-img":"margin:0px;height:18px;",".video-views":"font-size:10px;font-weight:normal;text-decoration:none;color:black;",".tbl-cta-style .cta-button":"font-family:Helvetica, Arial, sans-serif;background-color:transparent;border-color:#999990;color:#333333;"}}},"language":"en","testmode":false,"direction":"ltr","default-thumbnail":"http://cdn.taboola.com/libtrc/static/thumbnails/759bc49732394dde468c8d65a464e1a4.png","domains":"","sponsored-link-text":"Sponsored Link","sponsored-video-text":"Sponsored Video","branding-url":{},"configuration-version":"0","external-credentials":"","brightcove-list-id":"","publisher-start":function(){ },"get-user":function(){return null;},"get-creator":function(){var m=document.getElementsByTagName('head')[0].getElementsByTagName('meta', false);for(var i=0;i<m.length;i++){if(m[i].name=='uploader'||m[i].name=='item-uploader')return m[i].content;}},"get-views":function() {var m=document.getElementsByTagName('head')[0].getElementsByTagName('meta', false);for(var i=0;i<m.length;i++){if(m[i].name=='views'||m[i].name=='item-views')return m[i].content;}},"get-rating":function() {var m=document.getElementsByTagName('head')[0].getElementsByTagName('meta', false);for(var i=0;i<m.length;i++){if(m[i].name=='rating'||m[i].name=='item-rating'){ if(!isNaN(parseFloat(m[i].content))) return m[i].content;}}},"get-tags":function() {return [];},"logo-image":"http://cdn.taboolasyndication.com/taboola/powered-by.png","has_valid_rss":false,"actionscript_version":"3","brightcove-uses-reference":false,"publisher-end":function(id){ },"ie-logo-image":"http://cdn.taboolasyndication.com/taboola/powered-by-small.gif","attribution":true,"notify-loaded":true,"metafields":"","normalize-item-id":function(itemid,type,canon){if(!canon&&type=='text'&&typeof itemid=='string'&&itemid.search(new RegExp('^https?://'))==0)itemid=itemid.replace(/\?.*/,'', false);return itemid.toLowerCase();},"normalize-item-url":function(itemurl,type,canon){return itemurl;},"read-paused-bcplayer":false,"normalize-request-param":function(req,mode) {return req;},"normalize-log-param":function(name,value,mode) {return value;},"timeout":8000,"prenormalize-item-id":{"host":true,"fragment":"^(/video/|!)","query":["p","id"],"truncate-at":["search.searchcompletion.com","org.mozilla.javascript.undefined"],"trailing-dirsep":true},"prenormalize-item-url":false,"loader-impl":"","trc-network-mapping":{},"trc-skip-failover":false,"backstage-domain-url":"","adc-config":null,"link-target-conf":null,"ios-sc-link-target":{'NAV': '_self', 'NT': '_self', 'SP': '_self'},"small-ios-device":"iPhone|iPod","read-more-debug":false,"read-more-devices":"smart_phone","attribution-disclosure-direction":"ltr","mode-pub-start":function(){ },"before-video-load":function(){ return true; },"publisher-logo":{},"detect-item-from-same-host":function(host, itemHost){},"mode-before-video-load":function(rbox){ return true; },"after-card-created":function(placementData, publisherCardNum, feed){ },"publisher-branding":{"skimlinks-purewow":"Pure Wow"},"feed-view-devices":"smart_phone","feed-view-enable":false,"global":{"requests-domain":"trc.taboola.com","stop-channels-threshold":"0.8","syndication-embed-code":function (box, recommendation, affiliate) {},"syndicator-affiliate-id":"","explore-delay":500,"visible-delay":500,"css-isolation":false,"inject-comscore":false,"has-userx":true,"disclosure-enabled":true,"trc-request-delay":500,"publisher-onclick-nt-enabled":false,"touchstart-enabled":true,"use-storage-detection":true,"thumb-lazy-load-switch":false,"thumb-lazy-load-method":"PAGE_LOAD,PAGE_INTERACTIVE,RBOX_VISIBLE","inject-mdotlabs":false,"use-calibration-uim":false,"inject-taboolax":false,"use-delay-image-load":true,"abp-detection-enabled":true,"switch-abp-class":false,"use-abp-uim":true,"send-event-as-post":true,"image-url-prefix":"https://images.taboola.com/taboola/image/fetch/f_jpg%2Cq_auto%2Ch_{h}%2Cw_{w}%2Cc_fill%2Cg_faces:auto%2Ce_sharpen/","enable-social-events":true,"tmp-use-pb-params":true,"send-avail-as-post":true,"send-full-list":true,"enable-organic-redirect":true,"send-avail-as-get":false,"send-visible-as-get":false,"ios-sc-link-target":{"NAV": "_top", "NT": "_top", "SP": "_top"},"has-adchoice":true,"send-variant-warning":true,"enable-read-more":true,"enable-rbox-map":false,"enable-trc-cache":true,"trc-cache-it":{"text":"c","home":"d","video":"d","search":"d","category":"d","photo":"d","other":"d"},"enable-deferred-visible":true,"enable-manual-visible":true,"enable-events-api":true,"events-api-click-enabled":true,"enable-deferred-available":true,"send-pb-in-click":true,"force-reset-on-ready":true,"show-rtb-ad-choices-icon":true,"send-item-query-string-in-req":true,"send-user-id-tag":true,"user-id-tag-macros":["tags.bluekai.com/site/35702?id={taboolaID}"],"disable-yield":true,"smart-ellipsis":true,"rtb-image-url-prefix":"https://images.taboola.com/taboola/image/fetch/$pw_{w}%2C$ph_{h}/t_tbl-cnd/","enable-ie-split-click-event":true,"enable-multi-pv3":true,"cloudinary-aspect-ratios-list":[[1,4],[1,3],[1,2.5],[1,2],[1,1.9],[1,1.8],[9,16],[1,1.7],[1,1.6],[1,1.5],[1,1.4],[3,4],[1,1.3],[1,1.2],[1,1.1],[1,1],[1,0.9],[6,5],[1,0.8],[4,3],[1,0.7],[3,2],[1,0.6],[16,9],[2,1]],"store-userid-first-party-cookie":true,"enable-analytics":"true","config-analytics":{logTimer: 50000, logLength : 5, traffic : 1, measureEnable : true, measureTimeToSend : 10000, disableRawDataSend: true},"enable-detect-bots":true,"allow-nofollow-for-exchange":true,"visibility-intersection-api-delay":1000,"rbox-ajax-post-events-full-rollout":true,"rbox-post-events-as-ajax":true,"prefer-response-session-data":true,"enable-visibility-intersection-api":true,"visibility-intersection-api-full-rollout":true,"has-mode-geometry":true,"feed-observer-load-next-batch":true,"rbox-enable-fix-user-id-event":"true","use-native-json-stringify":true,"max-wait-for-cmp":5000,"disable-unified-iframe-pixel-reporter":true,"consent-presets":{taboola_default:null},"p-video-overlay-send-events":true,"monitor-dup-items-traffic-pct":5,"rbox-old-chrome-es6-fix":(function(){})(),"exclude-subd-shift":["15.taboola.com", "trc.taboola.com", "authentication.taboola.com"],"send-next-up-click-abtest-event":false,"enable-organic-redirect-on-amp":true,"enable-trc-route":true,"amp_target":"_top","disable-rbox-usage-logging":false,"cdn-taboola-path":"cdn.taboola.com","ui-innovation-modules-path":"ui-ab-tests","disable-scope-feed-css":false,"enable-experiments-variant-id-event":true,"enable-loader-type-event":true,"user-stop-retarget-campaign-after-click":"false","rbox-trc-protocol":"https:","enable-explore-more":true,"enable-item-override":true,"cloudinary-encoding-and-100-round-factor":{},"event-logger:publisher-enable-spatial-events":true,"spatial-slots-throttle-th":1000,"feed-max-num-of-consecutive-failed-requests":"5","enable-bulk-events":"true","bulk-available-events-strategy":"delay","enable-spatial-data-per-page":1,"enable-consent":true,"read-more-events-enabled":"0.1","GPT-refresh-control":true,"has-page-geometry":true,"has-page-geometry-extended":true,"has-slots-geometry":true,"has-slots-saliency":true,"bulk-available-events-delay":1000,"disable-iframe-for-tracking-pixel":true,"use-dpr-images":true,"disable-explore-more-video-reset":true,"enable-explore-more-video":true,"enable-exm-inside-iframe":false,"enable-explore-more-state-check":true,"default-event-route":"trc-events.taboola.com","trc-event-route-template":"<dc>-trc-events.taboola.com","enable-real-time-user-sync":true,"disable-sponsored-for-links":false,"enable-mode-injection":true,"mw-display-none-on-no-items-to-render":true,"enable-text-over":"true","cloudinary-encode":true,"rbox-error-stack-reporting-pct":0.01,"thumbnail-transformation-per-item-is-enabled":"1","image-optimization-url-per-item-is-enabled":"1","keep-referrer-in-session":true,"amp-support-consent-string":"true","video-gdpr-applies-use-requires-consent":"true","event-types-to-route":["debug","perf","metrics","bulk-metrics","abtests","supply-feature"],"enable-loader-cache-buster":true,"bulk-body-debug-sample-rate":1.0E-4,"enable-custom-injection":true,"block-video-prob":0.1,"enable-video-ajax":true,"cds:send-uad":true,"cds:send-dnid":true,"enable-real-time-user-sync-with-consent":true,"enable-bid-detection":0,"defer-cookie-sync":2000,"defer-userx-render":1000,"defer-scripts-render":500,"advanced-feed-view-telemetry-enabled":"0.01","lazy-render-enbale":true,"enable-new-ellipsis-module":1,"lazy-render":{enable: true, raKill: true},"lazy-render-enable":true,"flc-enabled":true,"tm-dynamic-load":"true","explore-more-google-timer":10,"new-logging-mechanism-on":0.1,"thumbs-image-lazy-load-margins":"2500px 1500px 2500px 1500px","enable-call-to-action-creative-component":false,"rbox:collect-eid-from-page":false,"default-stories-height":135,"read-more-scroll-fast-enabled":true,"pass-browser-url":true,"user-mapping-enabled":true,"video-split-start-unit":true,"enable-cta-component":true,"trcinfo-sample-rate":0.05,"view-tag-delay":10000,"bulk-metrics-events-strategy":"delay","rbox-metrics-enabled":0.1,"view-tags-domains-url":{'adsafeprotected.com': 1, 'cdn.doubleverify.com': 1},"read-more-click-delay":true,"cta-abtest-report-percent":-1,"cta-usage-report-percent":0.02,"cta-render-report-percent":0.05,"explore-more-enable-position-correction":true,"view-lazy-load-tags":{'z.moatads.com':1, 'cdn.doubleverify.com':1, 'adsafeprotected.com':1, 'googlesyndication.com':1},"view-lazy-load-tags-margin":20,"header-bidding-enabled":0.01,"enable-ios-back-fix":true,"item-override-encode-fields":true,"cta-metric-report-percent":0.1,"motion-ads-track-events":0.001,"html-card-max-width":"800px","motion-ads-load-old-version":0,"use-unit-fetcher-response-instead-of-tb":true,"send-rv-avail-as-post":true,"send-rv-avail-as-get":false,"enable-rv-available":true,"encode-irregular-og:url":true,"explore-more-enable-hide-all-but-header":true,"html-track-events":0.1,"high-entropy-values-arguments":["platformVersion","mobile","model","platform","uaFullVersion"],"vignette-lazy-load":true,"enable-hai-report":true,"load-user-agent-data":true,"get-vignette-config-from-products":true,"display-ad-to-native":true,"rbox-error-fullUrl":0.01,"remove-old-vignette-disclosure":true,"spa-detection-enabled":0.01,"send-id-providers-data":true,"send-alternate-container-width":true,"enable-slice-url":"0","unintentional-clicks-default-send-init-event":true,"enable-ampsplitfeedfix":true,"app-install-sanity-report-fraction":0.1,"vignette-capture-page-click":true,"vignette-new-scanning-logic":true,"unintentional-clicks-ignore-demand-enablement":false,"enable-rbox-es-events":0.003,"display-rv-visible-timeout":0,"enable-item-measurements":true,"enable-only-full-visible-event":"1","eid:rbox:common-eid-keywords":"help,support,contact,readme,test,info,reply,careers,spam,login,subscribe,feedback,reachus,customers,cookie,members","enable-real-time-user-sync-for-all-browsers":true,"cloudinary-isi-ratios":true,"enable-isi-card":true,"test_for_fraud_from_tag_loader":true,"isi-metric-report":1,"app-install-report":0.1,"shift-redir-onclick":true,"motion-ads-retry-play-timeout":2000,"external-visibility-by-items":true,"trc:blockers:WebComponentRBlockerQuery:blocker-web-component-passed-logger-for-creative-type:APP_INSTALL":"true","trc:blockers:WebComponentRBlockerQuery:blocker-web-component-passed-logger-for-creative-type:ISI_CARD":"true","adjust-banner-height":true,"explore-more-supply-feature-percent":true,"unintentional-clicks-default-enable":true,"unintentional-clicks-default-uicm":0,"unintentional-clicks-default-uics":0.5,"monitor-article-distance-from-feed-percentage":true,"image-cropping-report":0.1,"image-cropping-ratios-list":[[16,9],[4,3],[6,5],[2,1]],"image-cropping-active":1,"share-button-detection-report-percentage":0.1,"enable-local-dcl":false,"motion-ads-viewport-lazy-load":1,"motion-ads-viewport-lazy-load-margin":0.5,"article-and-feed-area-scanner-report-percentage":0.15,"new-cta-enabled":true,"report-cta-metrics":0.1,"explore-more-enable-missing-header-event":true,"motion-ads-preload-attribute":"","enable-explore-more-header-z-index":false,"enable-warn-tbt":0.05,"disclaimer-color-scheme":"","disclaimer-color-scheme-mode":"","enable-explore-more-history-hook":false,"disable-overlay-visibility-report-fix":0,"enable-em-history-hook":true,"motion-ads-cloudinary-prefix":"q_auto:low","enable-em-publisher-start-history-hook":true,"enable-warn-TBT":0.05,"enable-trecs-net":true,"google-fonts":["Poppins"],"intersection-should-throw-error-on-missing-attribute":1,"intersection-should-not-throw-error-on-missing-attribute":1,"cta-ignore-detail-order":true,"topics-enabled":true,"responsive-utils-report":0.01,"enable-responsive-float-fix":true,"loaf-threshold":50,"loaf-token":"A9irCqaHWp+prcT32cE7NQKUrKlHBR0STfIUHk2K4O2XW2IF8U8+hPEPzpUOF8cE3TNBsJCzKvw8mBjLpKiHawEAAACIeyJvcmlnaW4iOiJodHRwczovL2Nkbi50YWJvb2xhLmNvbTo0NDMiLCJmZWF0dXJlIjoiTG9uZ0FuaW1hdGlvbkZyYW1lVGltaW5nIiwiZXhwaXJ5IjoxNzA5NjgzMTk5LCJpc1N1YmRvbWFpbiI6dHJ1ZSwiaXNUaGlyZFBhcnR5Ijp0cnVlfQ==","enable-img-dim-fix":false,"enable-filler-block":true,"trecs-motion-ads-fade":0,"trecs-motion-ads-pause-enabled":0,"trecs-motion-ads-fade-enabled":0,"header-bidding-wait-for-win-events-timeout":2000,"header-bidding-is-add-placement":true,"yield-token":"A+uXoByCfR5HCRAl94AWMQ8Y7DHd3670DSOPWj55vVOoaN/cUpF/r0yk6KbxjLIyaxJ2H3/YX4ZxkiI3srY5oQwAAABreyJvcmlnaW4iOiJodHRwczovL2Nkbi50YWJvb2xhLmNvbTo0NDMiLCJmZWF0dXJlIjoiU2NoZWR1bGVyWWllbGQiLCJleHBpcnkiOjE3MDk2ODMxOTksImlzVGhpcmRQYXJ0eSI6dHJ1ZX0=","enable-yield":1,"use-scheduler-yield":true,"image-cropping-with-c-fill":0,"header-bidding-v3":true,"rbox:serving-piggyback-enabled":true,"header-bidding-catchup-timeout":7000,"web-component-app-install-version":2,"app-install-multi-slot-border":true,"activate-gpp-consent":true,"bakeTime":1705237451173,"maxRevision":151131611,"publisherName":"skimlinks-purewow","rbox:rtb:real-time-user-sync:intent-iq:external-partners-ids":[15042,24,15040,10197,15027,15308,53,15175,15251,15151,15355,10262,10141,10086,15176,15038,10144],"style":{"rtl":"","custom":"","mode_custom":""},"locale":null},"systemFlags":{"loaderType":"deflated"}};
    if (!TRC.inflate) {
        start(bakerConfig);
    } else {
        TRC.inflate.getConfig(bakerConfig).then(function (inflatedConfig) {
            start(inflatedConfig);
        });
    }

    function start(config) {
        if (!config.global['disable-config-override'] && typeof TRC.configOverride === "object") {
            setConfig(config.global, TRC.configOverride);
        }

        initDynamicModules();

        var rtbIndex = 0,
            waitForTrkTimeout = config.global['loader-ready-timeout'] || 500,
            DEFAULT_PROTOCOL = (config.global['rbox-default-protocol'] || 'https') + ':',
            PRECONNECT_DOMAINS = (config.global['preconnect-domains'] || ['trc.taboola.com', 'images.taboola.com']);

        // monitor user timings
        TRC.utm.start = (new Date).getTime();
        TRC._taboolaClone = [];
        TRC.PROTOCOL = config.global['rbox-trc-protocol'] || ((win.location.protocol.match(/http/)) ? win.location.protocol : DEFAULT_PROTOCOL);
        TRC.SYNDICATED_CLASS_NAME = "syndicatedItem";
        TRC.SPONSORED_CONTAINER_CLASS_NAME = "trc-content-sponsored";
        TRC.rtbRealTimeUserId = null; // User id record for RTB real time user sync
        TRC.version = getParameter('tbl_rbox_version', win.location) || TRC.version || 'TABOOLA-DEFAULT-VERSION-SNAPSHOT';
        TRC.imageCounter = 0;
        TRC.implInlined = TRC.implInlined || false;
        TRC.implCustomFile = TRC.implCustomFile || "";

        win._tblConsole = win._tblConsole || [];
        TRC.EVENT_LOOP_INTERVAL = config.global['rbox-perf-el-interval'] || 1000;
        TRC.EVENT_LOOP_REPORT_INTERVAL = config.global['rbox-perf-el-report-interval'] || 5000;


        TRC.pConsole = function (tab, type, title, infoValue, infoType) {
            try {
                if (win._tblConsole.length > 400) {
                    win._tblConsole = [];
                }
                _tblConsole.push({
                    service: "RBox",
                    tab: tab,
                    log: {
                        type: type,
                        title: title,
                        infoValue: infoValue,
                        infoType: infoType || "string",
                        tstmp: (new Date().getTime())
                    }
                });
            } catch (e) {
            }
        };
        TRC.pConsole("", "time", "loader.js loaded", "");
        TRC.pConsole("page", "info", "user agent", navigator.userAgent);

        TRC.isOptim = function (type) {
            return !!(config.global['feed-optim'] && config.global['feed-optim'][type]);
        };

        TRC.hasES6Support = function () {

            checkES6SupportByChrome();
            if (typeof eS6SupportCheckResult !== 'undefined') {
                return eS6SupportCheckResult;
            }

            checkES6SupportByFeatures();

            return eS6SupportCheckResult;

            function checkES6SupportByChrome() {
                var version = parseInt(window.navigator.userAgent.replace(/(?:.*chrome\/)(\d+)\.*(?:.*)/gim, '$1', 10));

                if (version && !isNaN(version) && version < 49) {
                    eS6SupportCheckResult = false;
                }
            }

            function checkES6SupportByFeatures() {
                eS6SupportCheckResult = true;

                try {
                    eval("var foo = (x)=>x+1");
                } catch (e) {
                    eS6SupportCheckResult = false;
                }
            }
        };

        TRC.styleInjected = false;
        var protocol = TRC.PROTOCOL,
            /** @type TRC.Manager */ trc = null, // reference to the TRC implementation instance
            globalMessages = [], // messages pertaining to global configuration
            originalErrorHandler = win.onerror,
            implElm = null, // The implementation script element that was loaded
            requests = [], // messages that request rendering of UI
            notificationsFirst = [],
            requestDispatchTimeout = null, // timer to manage rendering calls
            notifications = [], // messages that notify of events
            socials = [], //social events
            p13ns = [],
            abtests = [],
            debugs = [],
            apiListeners = [], //api events handlers
            manualVisibles = [],
            globalParams = {publisher: TRC.publisherId = 'skimlinks-purewow'}, // global configuration parameter
            flush = false, // whether we have a flush request in the queue
            queue = null, // this queue implementation
            PAGE_TYPES = {
                'video': 'video',
                'article': 'article',
                'category': 'category',
                'home': 'home',
                'search': 'search',
                'photo': 'photo',
                'video_source': 'video',
                'other': 'other',
                'content_hub': 'content_hub'
            },
            TBX_PAGE_TYPE_VAR = "pm_pgtp",
            taboolaXHosts = {'prod': "//pm-widget.taboola.com", 'sb': "//pm-widget-sandbox.taboola.com"},
            taboolaXHost = taboolaXHosts['prod'],
            isTBXInit = false,
            loaderHostName = null,
            loaderDomain,
            eS6SupportCheckResult;

        TRC.pConsole("page", "info", "from global params : publisher-id was set to - " + globalParams.publisher);

        win.onerror = function (msg, url, linenumber) {
            try {
                if (/^https?:\/\/(?:\w+\.)?taboola(syndication)?\.com/.test(url)) {
                    __trcError && __trcError(msg, linenumber + "@" + url);
                }
            } catch (e) {
            }
            return originalErrorHandler && originalErrorHandler.apply(win, Array.prototype.slice.call(arguments));
        };

        function setConfig(globalConfig, newConfig) {
            for (var prop in newConfig) {
                if (newConfig.hasOwnProperty(prop)) {
                    globalConfig[prop] = newConfig[prop];
                }
            }
        }

        /**
         * Initialize publisher predefined dynamic modules (dynamic modules will be built into the placeholder).
         */
        function initDynamicModules() {
            function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

            function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

            function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

            function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

            function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

            function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

            (function () {
                var DYNAMIC_LINKS_CONTAINER = 'taboola_main_dynamic_links';
                var DYNAMIC_LINKS_MODE = 'invisible-dynamic-links-mode';
                var DYNAMIC_LINKS_PLACEMENT = 'invisible-dynamic-links-source-placement';
                var RESPONSE_FORMAT_REGEX = /(.+)-([^\d]+)(\d*[.,]?\d+);([^\d]+)(\d*[.,]?\d+)/;
                var BATCH_SIZE = 9; // matches to the number of early rtb launchers for publisher

                var skimlinksConfig = window.__SKIM_JS_BTN_WIDGET__;

                function handleDynamicLinks() {
                    var pageNavigation = false;

                    if (TRCImpl.getItemId) {
                        pageNavigation = TRC.DynamicLinksLoader.currentItemId && TRCImpl.getItemId() !== TRC.DynamicLinksLoader.currentItemId;
                        TRC.DynamicLinksLoader.currentItemId = TRCImpl.getItemId();
                    }

                    if (TRC.dynamicLinksStarted && !pageNavigation) {
                        return;
                    }

                    TRC.dynamicLinksStarted = true;

                    function collectAllProducts() {
                        var products = [];
                        var selector = "".concat(skimlinksConfig.cardSelector, ":not([data-tbl-dl-fetched])");
                        Array.prototype.slice.call(document.querySelectorAll(selector)).forEach(function (cardDiv) {
                            var buttons = cardDiv.querySelectorAll(skimlinksConfig.buttonSelector);

                            if (buttons.length >= skimlinksConfig.maxLinksPerCard) {
                                return;
                            }

                            var productUrl = getButtonUrl(buttons[0]);
                            console.log("url ", productUrl)

                            if (!productUrl) {
                                return;
                            }

                            var product = {
                                url: productUrl,
                                links: skimlinksConfig.maxLinksPerCard
                            };

                            if(isProductExist(products, product)) {
                                console.log("equal", productUrl)
                            }
                            if (!isProductExist(products, product)) {
                                products.push(product);
                            }

                            cardDiv.dataset.tblDlFetched = 'true';
                        });
                        return products;
                    }

                    function isProductExist(products, product) {
                        return products.some(function (p) {
                            return p.url === product.url;
                        });
                    }

                    function createContainer(container) {
                        if (!document.getElementById(container)) {
                            var element = document.createElement('div');
                            element.id = container;
                            element.style.display = 'none';
                            document.body.appendChild(element);
                        }
                    }

                    function flush() {
                        window._taboola.push({
                                                 flush: true
                                             });
                    }

                    function sendBatchAndFlush(products, batchNumber) {
                        window._taboola.push({
                                                 mode: DYNAMIC_LINKS_MODE,
                                                 container: DYNAMIC_LINKS_CONTAINER,
                                                 placement: "".concat(DYNAMIC_LINKS_PLACEMENT, "-").concat(batchNumber),
                                                 target_type: 'mix',
                                                 should_render: function should_render() {
                                                     return false;
                                                 },
                                                 skip_dom_render: true
                                             });

                        window._taboola.push({
                                                 additional_data: {
                                                     dlp: products
                                                 }
                                             });

                        flush();
                    }

                    function sendBatchRequest() {
                        window._taboola = window._taboola || [];
                        var products = collectAllProducts();

                        if (products.length === 0) {
                            return;
                        }

                        flush(); // send dynamic links request separately from other requests

                        var batchSize = TRC.DynamicLinksLoader.globalConfig['dynamic-links-request-batch-size'] || BATCH_SIZE;
                        var currentBatch = 0;
                        var currentIndex = 0;

                        while (currentBatch * batchSize < products.length) {
                            var productsBatch = products.slice(currentIndex, currentIndex + batchSize);
                            sendBatchAndFlush(productsBatch, currentBatch);
                            currentBatch++;
                            currentIndex += batchSize;
                        }
                    }

                    function handleTrcResponse(data) {
                        if (!data || !data.mybox || !data.mybox.trcResponse) {
                            return;
                        }

                        var mybox = data.mybox;
                        var recommendation = mybox.trcResponse;

                        if (!recommendation.uuip || !recommendation.uuip.startsWith(DYNAMIC_LINKS_PLACEMENT)) {
                            return;
                        }

                        var items = getRtbItems(recommendation);

                        if (items.length === 0) {
                            // no alternative products
                            return;
                        }

                        var dlurl = recommendation.dlurl;
                        var allCards = document.querySelectorAll("".concat(skimlinksConfig.cardSelector, ":not([data-tbl-dl-optimize])"));
                        var isCardOptimized = false; // eslint-disable-next-line no-restricted-syntax

                        for (var _i = 0, _Array$from = Array.from(allCards); _i < _Array$from.length; _i++) {
                            var card = _Array$from[_i];
                            isCardOptimized = optimizeRelevantCard(card, dlurl, items, mybox);

                            if (isCardOptimized) {
                                break;
                            }
                        }

                        if (!isCardOptimized) {
                            // error - didn't find the card with url
                            console.error("Didn't find the card with url ".concat(dlurl));
                        }
                    }

                    function getMatch(buttons, dlurl) {
                        return getButtonUrl(buttons[0]) === dlurl;
                    }

                    function getButtonUrl(button) {
                        return button.getAttribute('href') || button.querySelector('a').getAttribute('href');
                    }

                    function optimizeRelevantCard(card, dlurl, items, rboxObj) {
                        var buttons = card.querySelectorAll(skimlinksConfig.buttonSelector);
                        var isMatch = getMatch(buttons, dlurl);

                        if (!isMatch) {
                            return false;
                        }

                        card.dataset.tblDlOptimize = 'true';

                        switch (skimlinksConfig.mode) {
                            case 'replace':
                                replaceButtons(buttons, dlurl, items, rboxObj);
                                break;

                            case 'add':
                                addButtons(card, buttons, dlurl, items, rboxObj);
                                break;

                            default:
                                console.error("Unknown mode ".concat(skimlinksConfig.mode));
                        }

                        handleVisible(rboxObj);
                        return true;
                    }

                    function replaceButtons(buttons, dlurl, items, rboxObj) {
                        for (var i = 0; i < buttons.length; i++) {
                            var button = buttons[i];
                            var recommendation = items[i];
                            var productDetails = getProductDetailsFromResponse(recommendation); // source 1 - optimizing existing button option only

                            var newButton = createAndConfigureNewButton(recommendation, productDetails, rboxObj, dlurl, i + 1, '1', getButtonUrl(button));
                            button.replaceWith(newButton);
                        }
                    }

                    function addButtons(card, buttons, dlurl, items, rboxObj) {
                        var existingUrls = Array.prototype.slice.call(buttons).map(function (button) {
                            return getButtonUrl(button);
                        });
                        var buttonsCount = buttons.length;
                        var alternatives = items;

                        while (buttonsCount < skimlinksConfig.maxLinksPerCard && alternatives.length > 0) {
                            var isAdded = tryAddNewButton(dlurl, card, existingUrls, rboxObj, alternatives, buttonsCount);

                            if (isAdded) {
                                buttonsCount++;
                            }
                        }
                    }

                    function checkIfUrlExist(existingUrls, url) {
                        var affiliateUrl = new URL(url);
                        var urlParam = affiliateUrl.searchParams.get('url');
                        var urlProduct = decodeURIComponent(urlParam);
                        var parseUrlProduct = new URL(urlProduct);
                        var merchantDomain = parseUrlProduct.hostname;
                        return existingUrls.some(function (existingUrl) {
                            return existingUrl.includes(merchantDomain);
                        });
                    }

                    function tryAddNewButton(dlurl, buttonsContainer, existingUrls, rboxObj, alternatives, buttonsCount) {
                        var recommendation = alternatives.shift();

                        if (!recommendation) {
                            return false;
                        }

                        var productDetails = getProductDetailsFromResponse(recommendation); // Assuming the product alternatives from the server are always unique,
                        // so no need to add them to the existingUrls after adding them to the page

                        if (checkIfUrlExist(existingUrls, recommendation.url)) {
                            tryAddNewButton(dlurl, buttonsContainer, existingUrls, rboxObj, alternatives, buttonsCount);
                        } else {
                            addNewButton(dlurl, buttonsContainer, rboxObj, recommendation, productDetails, buttonsCount + 1);
                            return true;
                        }
                    }

                    function appendXcreoParameter(url, buttonIndex, source) {
                        // The last digit is option active - 1.
                        var xcreoParameter = "400".concat(buttonIndex).concat(source, 1);
                        var uri = new URL(url);

                        if (uri.search.length > 0) {
                            uri.searchParams.set('xcreo', "".concat(xcreoParameter));
                        } else {
                            // If &xcreo doesn't exist, add &xcreo=<xcreoParameter>
                            uri.search = "xcreo=".concat(xcreoParameter);
                        }

                        return uri.toString();
                    }

                    function createButton(recommendation, productDetails, buttonIndex, source) {
                        var url = appendXcreoParameter(recommendation.url, buttonIndex, source);
                        // const locale = (navigator && navigator.language) || "en"; console.log(locale);
                        // const originalPriceBreakdown = productDetails.originalPrice.split(";")
                        // const priceBreakdown = productDetails.price.split(";")
                        // // const priceFormatter = Intl.NumberFormat(locale, { style: "currency", currency: originalPriceBreakdown[0] || "USD" })
                        // const price = priceFormatter.format(productDetails.amount) -- place holder to format prices
                        var newButtonStr = skimlinksConfig.template
                            .replaceAll('{{url}}', url)
                            .replaceAll('{{merchantName}}', productDetails.merchantName)
                            .replaceAll('{{originalPrice}}',`${productDetails.currency}${productDetails.originalAmount}`)
                            .replaceAll('{{currentPrice}}', `${productDetails.currency}${productDetails.currentAmount}`)
                            .replaceAll('{{currency}}', productDetails.currency)
                            .replaceAll('{{priceWithoutCurrency}}', productDetails.originalAmount)
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(newButtonStr, 'text/html');
                        return doc.body.firstChild;
                    }

                    function createAndConfigureNewButton(recommendation, productDetails, rboxObj, dlurl, buttonIndex, source, originalButtonLink) {
                        var newButton = createButton(recommendation, productDetails, buttonIndex, source);
                        setOptimizedElementData(newButton, recommendation, rboxObj);
                        sendOptimizeEvent(dlurl, recommendation.url, originalButtonLink);
                        addClickEvent(newButton, recommendation, rboxObj);
                        return newButton;
                    }

                    function addNewButton(dlurl, buttonsContainer, rboxObj, recommendation, productDetails, buttonIndex) {
                        // source 2 - alternative buttons option only
                        var newButton = createAndConfigureNewButton(recommendation, productDetails, rboxObj, dlurl, buttonIndex, '2');
                        buttonsContainer.appendChild(newButton);
                    }

                    function setOptimizedElementData(productData, recommendation, rboxObj) {
                        productData['item-id'] = recommendation['item-id'];
                        productData.video_data = recommendation;
                        rboxObj.boxes.push(productData);
                    }

                    function handleVisible(rboxObj) {
                        rboxObj.visibilityReporter = new TRC.WidgetVisibilityReporter(rboxObj);
                    }

                    function getProductDetailsFromResponse(recommendation) {
                        
                        var brandingTextResponse = recommendation['branding-text'];
                        var brandingText = brandingTextResponse.match(RESPONSE_FORMAT_REGEX);
                        var productDetails = {};

                        var _brandingText$map = brandingText.map(function (item) {
                            return item.trim();
                        });

                        var _brandingText$map2 = _slicedToArray(_brandingText$map, 4);

                        productDetails.merchantName = _brandingText$map2[1];
                        productDetails.currency = _brandingText$map2[2]
                        productDetails.originalAmount = _brandingText$map2[3];
                        // _brandingText[4] is current currency ammount
                        productDetails.currentAmount = _brandingText$map2[5];
                        return productDetails;
                    }

                    function getRtbItems(recommendation) {
                        return recommendation.v.filter(function (item) {
                            return item['is-rtb'] === 'true';
                        });
                    }

                    function addClickEvent(elem, recommendation, rboxObj) {
                        if (isFeatureFlagOn('dynamic-links-add-taboola-click-event', true)) {
                            elem.onmousedown = itemClicked.bind(null, elem, recommendation, rboxObj);
                        }
                    }

                    function itemClicked(elem, recommendation, rboxObj) {
                        var target = elem.href ? elem : elem.querySelector('a');
                        var originalUrl = target.href;
                        var url = getClickUrl(rboxObj, recommendation, originalUrl);
                        target.href = url.replace('&url', '&redir');
                        setTimeout(function () {
                            target.href = originalUrl;
                        }, 300);
                    }

                    function getClickUrl(rboxObj, recommendation, url) {
                        var listContainer = rboxObj.listContainer;
                        rboxObj.listContainer = {
                            id: 'rbox-t2m'
                        };
                        var clickUrl = rboxObj.createVideoBoxClickUrl(recommendation, url);
                        rboxObj.listContainer = listContainer;
                        return clickUrl;
                    }

                    function isFeatureFlagOn(key, defaultValue) {
                        var config = TRC.DynamicLinksLoader.globalConfig[key];
                        return config !== undefined ? config : defaultValue;
                    }

                    function sendOptimizeEvent(dlurl, recommendationUrl, originalUrl) {
                        if (!isFeatureFlagOn('dynamic-links-send-optimize-event', true)) {
                            return;
                        }

                        var data = {
                            pUrl: dlurl,
                            mode: skimlinksConfig.mode,
                            originalLink: originalUrl,
                            newLink: recommendationUrl
                        };
                        var requestData = {
                            data: JSON.stringify(data),
                            type: 'dynamicLinksOptimize'
                        };
                        setTimeout(function () {
                            TRCImpl.sendEvent('pubs-generic', {
                                d: JSON.stringify(requestData)
                            }, {});
                        }, 0);
                    }

                    createContainer(DYNAMIC_LINKS_CONTAINER);
                    TRC.listen('preBoxRender', handleTrcResponse);
                    sendBatchRequest();
                }

                var initDynamicLinks = function initDynamicLinks(config) {
                    try {
                        if (!config) {
                            __trcDebug("dynamic-links globals missing on pub init");

                            return;
                        }

                        var configPublisherKey = "send-dynamic-links-request-".concat(TRC.publisherId);

                        // if (!config[configPublisherKey]) {
                        //     return;
                        // }

                        TRC.DynamicLinksLoader.globalConfig = config;

                        if (window.TRCImpl) {
                            handleDynamicLinks();
                        } else {
                            TRC.EventsAPI.listen('trcImplAvailable', function () {
                                return handleDynamicLinks();
                            });
                        }
                    } catch (e) {
                        __trcError("Error in dynamic buttons module initialization: ".concat(e.message));
                    }
                };

                TRC.DynamicLinksLoader = {
                    initDynamicLinks: initDynamicLinks
                };
            })();

            TRC.DynamicModulesHooks = TRC.DynamicModulesHooks || [];
            TRC.DynamicModulesHooks.push({
                                             type: 'publisher-start',
                                             callback: TRC.DynamicLinksLoader.initDynamicLinks
                                         });


        }


        /**
         * Execute notification commands (API only)
         */
        function doNotifications() {
            // don't do anything yet
        }

        function doNotificationsFirst() {
            while (msg = notificationsFirst.shift()) {
                switch (msg.notify) {
                    case 'newPageLoad':
                        TRC.reset();
                        break;
                }
            }
        }

        /**
         * Locate the SCRIPT node that loaded loader.js and extract the base domain
         * @param {NodeList} scripts node list host object from the DOM. An array would also work
         */
        function findScriptBaseDomain(scripts) {
            var m,
                reFindScript = /^(.*\/libtrc\/.+\/)loader\.js(?:\?(.*))?$/;

            for (var i = 0; i < scripts.length; i++) { // traverse the scripts provided by my caller
                if (!scripts[i].src || !(m = scripts[i].src.match(reFindScript))) {   // find myself
                    continue;
                }

                // preload the base domain for the TRC (support CDN chaining)
                TRC.baseDomain = m[1];
                TRC.pConsole("page", "info", "base domain set to : " + TRC.baseDomain);

            }
        }

        /**
         * Execute notification commands (actual implementation)
         */
        function realDoNotifications() {
            var msg;
            while (msg = notifications.shift()) {
                switch (msg.notify) {
                    case 'videoPlay':
                        TRC.RBoxUsage.logUsage('realDoNotifications', {position: 'videoPlay'});
                        if (!this.preloadRequestLoader)
                            trc.playVideo(msg);
                        else {
                            // otherwise we should wait until the loadRBox response arrives
                            (function (e) {
                                // function indirection is used here to prevent the clobbering of the 'msg' scoped variable
                                // by the iterator
                                TRC.aspect.after(trc, 'handleLoadResponse', function () {
                                    trc.playVideo(e);
                                }, true);
                            })(msg);
                        }
                        break;
                    case 'videoDone':
                        TRC.RBoxUsage.logUsage('realDoNotifications', {position: 'videoDone'});

                        try {
                            TRC.dispatch('videoDone', msg);
                        } catch (e) {
                            trc.error("Problem in videoDone", e);
                        }
                }
            }
        }

        /**
         * !! see our text module !!
         * A utility split method to augment String.split by limiting the number of elements in the output
         * @param text String to split
         * @param delimiter Text string to split on. This can't be a regular expression!
         * @param limit maximum number of elements to return in the array - the last element will
         * contain all the remaining text after the n-1 delimiter, including any extra delimiters not removed
         */
        function lsplit(text, delimiter, limit) {
            var t = text.split(delimiter);
            return t.slice(0, limit - 1).concat(t.length >= limit ? t.slice(limit - 1).join(delimiter) : []);
        }

        /**
         * return the extracted host name
         * 1. without protocol
         * 2. wotks on absolute url's only
         * @param url
         * @return {String}
         */
        function getHostName(url) {
            var splits = [{key: '?', index: 0}, {key: '://', index: 1}, {key: '//', index: 1}, {
                    key: '/',
                    index: 0
                }, {key: ':', index: 0}],
                i = 0,
                len = splits.length,
                host = url,
                split;
            for (i; i < len; i++) {
                split = lsplit(host, splits[i].key, 2);
                host = (split.length > 1) ? split[splits[i].index] : split[0];
            }
            return host;
        }

        function fetchUserAgentData(highEntropyValuesArguments) {
            if (TRC.isGetHighEntropyValuesCalled) {
                return;
            }
            try {
                TRC.isGetHighEntropyValuesCalled = true;
                if (navigator && navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                    TRC.userAgentDataObject = {};
                    navigator.userAgentData.getHighEntropyValues(highEntropyValuesArguments ? highEntropyValuesArguments : ['platformVersion']).then(function(uad) {
                        if (uad) {
                            TRC.userAgentDataObject = {
                                mobile: uad.mobile,
                                model: uad.model,
                                platform: uad.platform,
                                platformVersion: uad.platformVersion,
                                uaFullVersion: uad.uaFullVersion
                            };
                        }
                    });
                }
            } catch (e) {
                __trcWarn('error on user agent data, ', e);
            }
        }

        /**
         * Calls the libtrc loadRBox or drawRBox API, when we have mode rendering commands
         */
        function sendLoadRBox() {
            requestDispatchTimeout = null; // the timeout has fired
            trc.loadRBox.apply(trc, requests);
            requests = []; // clear all requests that were sent
            (doNotifications = realDoNotifications)();
        }

        function detectBots() {
            var reg;
            if (config.global['enable-detect-bots']) {
                reg = new RegExp(config.global['detect-bots-regex'] || 'bot|google|baidu|bing|msn|duckduckgo|teoma|slurp|yandex', 'i');
            } else {
                return;
            }
            TRC.botDetected = reg.test(navigator.userAgent);
        }

        /**
         * Execute mode rendering commands (API only)
         */
        function doRequests() {
            // don't do anything yet
        }

        /**
         * Execute mode rendering commands (actual implementation)
         */
        function realDoRequests() {
            if (!requests.length)
                return flush = false; // nothing to do.
            // we turn off flush if it happens to be on (so the next push will not be flushed by mistake)
            if (flush) {
                flush = false;
                sendLoadRBox();
                return;
            }
            if (requestDispatchTimeout != null)
                TRC.Timeout.clear(requestDispatchTimeout);
            requestDispatchTimeout = TRC.Timeout.set(sendLoadRBox, trc.trcRequestDelay);
        }

        function registerAPIEvents() {
            var deferredPush;

            apiListeners.push = function (push) {
                TRC.EventsAPI.listen(push.listenTo, push.handler);
            };

            while (apiListeners.length) {
                deferredPush = apiListeners.shift();
                TRC.EventsAPI.listen(deferredPush.listenTo, deferredPush.handler);
            }
        }

        /**
         * Execute socials events
         */
        function doSocials() {
            // don't do anything yet
        }

        /**
         * Execute socials events
         */
        function realDoSocials() {
            //this event subscription will ensure social events are fired after we hold a response(thus holding an user id)
            TRC.eventDelegator.subscribe("user_id_ready", handleSocials);
        }

        function handleSocials() {
            try {
                sendSocials.call(null, socials);
            } catch (e) {
                TRC.pConsole("errors", "error", "error in handleSocials", e.message);
            }

        }

        /**
         * send socials events to trc server
         * @param socials
         */
        function sendSocials(socials) {
            var msg;
            while (msg = socials.shift()) {
                //the  'unescape-#' prefix signals the event logger not to escape the parameter name and value
                trc.sendEvent("social", {
                    'st': msg.name,
                    'unescape-d': encodeURIComponent(__trcJSONify({"data": msg.val}))
                }, null, false, null, null);
            }
        }


        /**
         * Checks whether the mode passes visibility constraints according to specified property.
         * e.g., if property "visibility-constraints" has value {maxWidth: 480}, and the current browser width
         * is 500, the mode should not be displayed and this method should return false.
         *
         * @param config - mode configuration
         * @param mode - mode name
         * @returns {boolean} - true/false if passed the constraints test
         */
        function checkModeVisibilityConstraints(config, mode) {
            var passed = true,
                windowWidth,
                widthDisplayRule;

            try {
                if (config.modes[mode]) {
                    widthDisplayRule = config.modes[mode]['visibility-constraints'];
                    if (widthDisplayRule && typeof widthDisplayRule == "object") {
                        windowWidth = window.innerWidth || document.body.clientWidth;
                        if ((widthDisplayRule.minWidth && windowWidth < widthDisplayRule.minWidth)
                            || (widthDisplayRule.maxWidth && windowWidth > widthDisplayRule.maxWidth)) {
                            passed = false;
                            TRC.pConsole("page", "info", "Mode '" + mode + "' will not be displayed due to visibility constraints", widthDisplayRule, "object");
                        }
                    }
                }
            } catch (e) {
                TRC.pConsole("page", "error", "Error while evaluating visibility constraints of mode '" + mode + "': " + e.message);
            }

            return passed;
        }

        TRC.reset = function () {
            TRC.pConsole("page", "debug", "reset RBox");
            requests = []; // messages that request rendering of UI
            requestDispatchTimeout = null; // timer to manage rendering calls
            isTBXInit = false;
            win.taboola_view_id = null; // reset current view id
            TRC._taboolaClone = [];
            TRC.pushedRboxTracking = false;
            notifications = []; // messages that notify of events
            globalParams = {publisher: TRC.publisherId = 'skimlinks-purewow'}; // global configuration parameter
            flush = false; // whether we have a flush request in the queue
            doNotifications = function () {
            };
            doRequests = function () {
            };

            try {
                TRC.pageTemplate = undefined;
                TRC.Timeout.reset();
                TRC.Interval.reset();
                if (trc && win.TRCImpl) {
                    trc.reset();
                    win.TRCImpl = trc = null;
                }
                if (TRC.eventDelegator) {
                    TRC.eventDelegator.resetEvents();
                }
            } catch (e) {
                TRC.pConsole("errors", "error", "error in TRC.reset", e.message);
            }
        };
        /**
         * callback to be notified when libtrc has loaded
         * @param {Object} defaults Object property list of pre-coded configuration
         * @return {TRC.Manager} the TRC singleton
         * @type TRC.Manager
         */
        TRC.ready = function (defaults) {
            config.defaults = defaults;
            config.version = TRC.version;

            if (config.global["enable-events-api"]) {
                registerAPIEvents();
            }

            setPush(manualVisibles, doVisibles);
            TRC.pConsole("page", "info", "configuration version +  : " + config.version);
            TRC.publisherId = globalParams.publisher;

            /* In most cases, We would not want to reinstantiate the TRC.Manager if it already exists and there was
             no reset prior. This flag enables this reinstantiation when it is needed, see Bloomberg autoscroll example. */

            if (config.global["force-reset-on-ready"]) {
                win.TRCImpl = trc = new TRC.Manager(config, globalParams); // cross register us and TRCImpl
            } else {
                win.TRCImpl = trc = trc || new TRC.Manager(config, globalParams); // cross register us and TRCImpl
            }

            // dispatch trcImplAvailable event after TRCImpl is made available
            if (!TRC.trcImplAvailableDispatched) {
                TRC.EventsAPI.dispatchTrcImplAvailable();
                TRC.trcImplAvailableDispatched = true;
            }

            // send publisher url before init
            __trcInfo(window.location.href);

            if (TRC.Rtus && shouldInjectRtus()) {
                new TRC.Rtus(TRC).applyRtus();
            }

            // its now safe to send render commands, so plug in the doRequests operation and invoke it
            (doRequests = realDoRequests)();

            if (config.global["enable-social-events"]) {
                (doSocials = realDoSocials)();
            }

            return trc;
        };

        function setLoaderDomains() {
            loaderHostName = (config.global['use-loader-host'] || config.global['enable-shift-cdn-domains']) ? getHostName(TRC.baseDomain) : null;
            loaderDomain = (loaderHostName) ? lsplit(loaderHostName, '.', 2).pop() : null;
        }

        TRC.shiftDomain = function (url) {
            if (!config.global['enable-shift-cdn-domains']) return url;
            var _url = url, urlDomain, blackListDomains = config.global['exclude-subd-shift'] || [],
                hostName = getHostName(url);
            if (loaderDomain && url) {
                urlDomain = lsplit(hostName, '.', 2)[1];
                if (blackListDomains.indexOf(hostName) < 0 && urlDomain.indexOf('taboola.com') > -1) {
                    _url = url.replace(urlDomain, loaderDomain)
                }
            }
            return _url;
        }

        /**
         * load script under taboola cdn
         * @param fileName
         * @param async
         * @param callbacks
         * @param errCallbacks
         */
        TRC.loadTaboolaScript = function (fileName, async, callbacks, errCallbacks) {
            var hostName = loaderHostName || "lepunk.github.io",
                scriptElms = doc.getElementsByTagName('script'),
                script;

            script = doc.createElement('script');
            TRC.addAnonymousCrossOrigin(script);
            if (scriptElms.length) {
                scriptElms[0].parentNode.insertBefore(script, scriptElms[0]);
            }
            script.charset = "UTF-8";
            script.type = "text/javascript";

            if (async) {
                script.setAttribute('async', 'async');
            }

            var callback = chainEventCallbacks(callbacks);
            if (callback) {
                script.addEventListener('load', callback, false);
            }

            var errCallback = chainEventCallbacks(errCallbacks);
            if (errCallbacks) {
                script.addEventListener('error', errCallback, false);
            }

            script.src = TRC.shiftDomain(protocol + '//' + hostName + '/libtrc/' + fileName);

            return script;
        };

        TRC.addAnonymousCrossOrigin = function (script) {
            var featureFlag = config.global['enable-crossorigin-anonymous-attribute'];
            var isCrossOriginAnonymousEnabled = featureFlag === true || featureFlag === "true" || featureFlag === 1 || featureFlag === "1";
            if( isCrossOriginAnonymousEnabled ){
                script.setAttribute('crossorigin', 'anonymous');
            }
        }

        function chainEventCallbacks(callbacks) {
            if (!callbacks) {
                return;
            }

            if (Array.isArray(callbacks)) { // honor onload handlers
                return function (e) {
                    callbacks.forEach(function (cb) {
                        cb(e);
                    });
                };
            } else if (typeof callbacks === 'function') {
                return callbacks;
            }
        }

        function vvReady() {
            TRC.adManager = new TRC.AdServerManager(config.global['vv-config'], TRC.version);
            TRC.adManager.startVV().then(function () {
                TRC.adManager.run();
            });
        }

        /**
         * Load a new javascript implementation file.
         * @param {String} file the file name to load from the libtrc CDN directory
         */
        function loadImplementation(file) {

            if (!!TRC.implInlined) {
                TRC.trcReady && TRC.trcReady();
                return;
            }
            if (TRC.implLoaded) {
                TRC.trcReady();
                return;
            }
            if (implElm) {
                return; // implementation file already loaded
            }

            implElm = TRC.loadTaboolaScript(file);
            (TRC.performance && TRC.performance.mark("3.0"));
            // monitor user timings
            TRC.utm.push((new Date).getTime() - TRC.utm.start);
            TRC.pConsole("page", "debug", "loading impl file : '" + file + "'");
        }

        /**
         * load visit value(vv.js) file
         */
        function loadVV() {
            if (TRC.AdServerManager) {
                return;
            }
            TRC.VVReady = vvReady;
            TRC.loadTaboolaScript('vv.' + TRC.version + '.js');
        }

        /**
         * Load a new javascript asset file
         * @param {String} file- the asset file name to load from the libtrc CDN directory
         */
        function loadAssetFile(file, config) {
            if (TRC.botDetected) {
                return;
            }
            var scriptElms = doc.getElementsByTagName('script'),
                headElms = doc.getElementsByTagName('head'),
                assetScript = doc.createElement('script');
            if (config && config.async) {
                assetScript.setAttribute('async', '');
            } else {
                assetScript.setAttribute('defer', ''); // this is our default for all our async scripts
            }

        if (config && config.crossorigin) {
            assetScript.setAttribute('crossorigin', config.crossorigin);
        }

            if (config && config.id) {
                assetScript.id = config.id;
            }

            assetScript.src = TRC.shiftDomain(file);

            if (config && config.forceInHead && scriptElms[0].parentNode.nodeName.toLocaleLowerCase() !== "head") {
                headElms[0].appendChild(assetScript);
            } else {
                scriptElms[0].parentNode.insertBefore(assetScript, scriptElms[0]);
            }

            TRC.pConsole("page", "debug", "loading : " + assetScript.src);
        }

        /**
         * Execute global properties commands, and load the implementation
         */
        function doGlobals() {
            if (!globalMessages.length)
                return; // no messages to check
            var msg, implFileFromParam, implFile;
            var implFileExtension = TRC.hasES6Support() ? '.js' : '.es5.js';

            while (msg = globalMessages.shift()) {
                for (var prop in msg) {
                    if (prop == 'onclick')
                        queue.onclick = msg[prop];
                    else
                        globalParams[prop] = msg[prop];
                }
            }

            if (TRC.implCustomFile) {
                implFile = TRC.implCustomFile + implFileExtension;
            } else {
                // Accepts parameters in the form of ?taboola_impl_file=impl, if doesn't exist or not in whitelist returns null
                implFileFromParam = getParameterOfWhitelist("taboola_impl_file", ['impl', 'impl.thin']);
                // Actually construct impl file name based on url param with fallback to baked default.
                implFile = implFileFromParam ? implFileFromParam + '.' + TRC.version + implFileExtension : 'impl.' + TRC.version + implFileExtension;
            }

            loadImplementation(implFile);
        }

        /**
         * Go over the messages in the queue and see what we can run with
         */
        function executeMessages() {
            doNotificationsFirst();
            doGlobals();
            doRequests();
            doNotifications();
            doSocials();
        }

        /**
         * register to AMP observeIntersection -  we need to cache rect data (the size of the AMP iframe)
         * to use it after the widget is rendered.
         */
        function registerToAMP_API() {
            //report page as amp
            var ampVersion = (window.AMP_MODE && window.AMP_MODE.version) ? window.AMP_MODE.version : "1";
            TRC.isAMP = true;
            window._taboola.push({
                additional_data: {
                    sdkd: {
                        "os": "AMP",
                        "osv": ampVersion,
                        "sdkt": "Taboola AMP Driver",
                        "sdkv": "1"
                    }
                }
            });
            window._taboola.push({
                listenTo: 'nocontent',
                handler: function (eventObj) {
                    var c = document.querySelector('.trc_rbox_container .trc_rbox_div');
                    if (c && c.offsetHeight > 10 || eventObj.detail.isFeedCard) return;
                    window.context.noContentAvailable();
                }
            });
            window.context.observeIntersection(function (changes) {
                changes.forEach(function (c) {
                    window._taboola.push({
                        intersection: true,
                        rects: c,
                        placement: window.context.data.placement
                    });
                    if (TRC.lastVisibleRects) { //cache last AMP rect data - http://rawgit.com/slightlyoff/IntersectionObserver/master/index.html#intersectionobserverentry
                        if (c.time > TRC.lastVisibleRects.time) {
                            TRC.lastVisibleRects = c;
                        }
                    } else {
                        TRC.lastVisibleRects = c;
                    }

                });
            });
        }

        /**
         * detect message type and dispatch accordingly
         */
        function dispatchMessage(msg) {
            if (typeof msg.overrideConfig === "object" && msg.overrideConfig != null) {
                TRC.overrideGlobalConfig = msg.overrideConfig.global;
                mergeObject(config, msg.overrideConfig, 0);
                return;
            }

            var socialType,
                taboolaxp;

            extractSubscription(msg);
            updateAmpMessageURL(msg);

            // Those checks are separated because we want to take it also from inside any message.
            if (msg.cex && config.global['cex-enable'] !== false) {
                TRC.cexConsentData = msg.cex;
            }
            if (msg.cdns && config.global['ccpa-cdns-enable'] !== false) {
                TRC.ccpaCdns = msg.cdns;
            }
            if (msg.ccpaPs && config.global['ccpa-ps-enable'] !== false) {
                TRC.ccpaPs = msg.ccpaPs;
            }

            //we check that excluded publisher are existing and not empty
            if (!!msg.exp) {
                TRC.exp = msg.exp;
            }

            // send geo data that provided b y the publisher (coordinates) to TRC
            if (!!msg.geo) {
                TRC.geo = msg.geo;
            }

            // disable organic personalization (HPP)
            if (!!msg.opDisabled) {
                TRC.opDisabled = true;
            }

            // add custom segment
            if (!!msg.cseg) {
                TRC.cseg = msg.cseg;
            }

            if(!!msg.pubExperiment) {
                TRC.pubExperiment = msg.pubExperiment;
            }

            if (!!msg.mode) {
                TRC.pConsole("page", "info", "push to '_taboola' - mode : " + msg.mode, msg, "object");
                if (!!msg.framework) {
                    globalMessages.push({framework: msg.framework}); //hack for AMP
                    if (msg.framework === 'amp') {
                        registerToAMP_API();
                    }
                } else if (config.global["enable-cls-plc-optim"]) { // CWV - reducing CLS by seting min-height on container before rendering
                    containerExpand(msg.placement, msg.container);
                }
                if (checkModeVisibilityConstraints(config, msg.mode)) {
                    requests.push(msg);
                }
            } else if (!!msg.listenTo) {
                if (msg.handler && typeof msg.handler === 'function') {
                    apiListeners.push(msg);
                } else {
                    TRC.pConsole("page", "warn", "events API listening to event without a handler.");
                }
            } else if (!!msg.notify) {
                if (msg.notify == 'newPageLoad') {
                    TRC.pConsole("page", "info", "push to '_taboola' - notification : newPageLoad");
                    resetAllMessages();
                    notificationsFirst.push(msg);
                } else {
                    notifications.push(msg);
                }
            } else if (msg.name && msg.name.indexOf('p13n-') !== -1) {
                p13ns.push(msg);
            } else if (msg.name && msg.name.indexOf('abtests') !== -1) {
                abtests.push(msg);
            } else if (msg.clsfilter) {
                TRC.CLSEvents = TRC.CLSEvents || [];
                if (Array.isArray(msg.clsfilter)) {
                    msg.clsfilter.forEach(function (e) {
                        TRC.CLSEvents.push(e);
                    });
                } else {
                    TRC.CLSEvents.push(msg.clsfilter);
                }
            } else if (socialType = getSocialEvent(msg)) {
                socials.push({name: socialType, val: msg[socialType]});
            } else if (msg.debug) {
                debugs.push(msg.debug);
            } else if ((msg.intersection || msg.visible) && msg.placement) {
                manualVisibles.push({event: 'visible::' + msg.placement, rects: msg.rects}); // AMP notifies a placement is visible
            } else {
                taboolaxp = getParameter("taboolax-load", win.location);
                if ((config.global['inject-taboolax'] || taboolaxp) && !isTBXInit && setTBXPageType(msg)) {
                    taboolaXHost = (taboolaxp) ? taboolaXHosts[taboolaxp] : taboolaXHost;
                    isTBXInit = true;
                    injectTaboolaX(taboolaXHost);
                }
                if (!!msg.template && TRC.pageTemplate === undefined) {
                    TRC.pageTemplate = msg.template;// allow only one template push
                }
                globalMessages.push(msg);
            }
            if (!!msg.flush) flush = true;
        }

        /**
         * dispatch external(e.g. AMP) visible events
         * @param event
         */
        function doVisibles(data) {
            TRC.dispatch(data.event, data.rects);
        }

        /**
         * register new overloaded push method on array an parse past native pushes
         * @param arr
         * @param func
         */
        function setPush(arr, func) {
            var msg;
            arr.push = func;
            while (msg = arr.shift()) {
                func(msg);
            }
        }

        /**
         *  extract social events
         *  {Object} msg
         *  return {String} - social event name
         */
        function getSocialEvent(msg) {
            try {
                for (var i in msg) {
                    if (i.indexOf('social-') == 0 && msg.hasOwnProperty(i)) {
                        return i;
                    }
                }
            } catch (e) {
            }
            return null;
        }

        function extractSubscription(msg) {
            var subscribe;
            try {
                if (!msg.onrender) {
                    return
                }
                if (TRC.eventDelegator) {
                    subscribe = TRC.eventDelegator.subscribe;
                } else {
                    TRC.subscriptionRegister = [];
                    subscribe = function (event, handler, mode, container) {
                        TRC.subscriptionRegister.push({"event": event, "handler": handler, "container": container});
                    };
                }
                subscribe("onrender", msg.onrender, (msg.container) ? getContainerId(msg.container) : null);
            } catch (e) {
                __trcError && __trcError("extractSubscription", e);
            }
        }

        function updateAmpMessageURL(msg) {
            // We are doing the change of URL here because the actual URL arrive from AMP plugin is not correct
            // and is directing to the publisher AMP page type and not the standard page.
            // This causing Taboola Feed to link to article as AMP and we appear inside an iFrame and not on the window.top.
            // The reason I do it for all instances is the default URL the AMP pass is AMP and not non-AMP.
            // In addition, we need to have all Query Params as the URL.

            var isAmpUrlMessage = TRC.isAMP && msg.hasOwnProperty("url") && !!window.context;
            if (config.global['disable-amp-url-override'] || !isAmpUrlMessage) {
                return;
            }

            msg.url = window.context.canonicalUrl + window.context.location.search;
        }

        /**
         * get parameters values in page location query string (a.k. as search string)
         * @param name
         * @param url
         * @returns {*}
         */
        function getParameter(name, locationObj) {
            var kv, i,
                params = locationObj.search.substr(1).split(/&/);
            for (i = 0; i < params.length; i++) {
                kv = params[i].split(new RegExp("="), 2);
                if (kv[0] == name)
                    return kv[1];
            }
            return null;
        }

        function getParameterOfWhitelist(name, whitelist) {
            var param = getParameter(name, win.location);
            for (var i = 0; i < whitelist.length; i++) {
                if (whitelist[i] === param) {
                    return param;
                }
            }
            return null;
        }

        /**
         *
         * @param container
         * @returns {*}
         */
        function getContainerId(container) {
            if (typeof container === "string") {
                return container;
            } else {
                return msg.container.id || "trc_cont_ " + parseInt(Math.random() * 10000);
            }
        }

        /**
         *  set the global page type for taboola-X
         * @param types {Array}
         * @param global {String}
         * @return  {String}
         */
        function setTBXPageType(msg) {
            var i;
            for (i in msg) {
                if (PAGE_TYPES.hasOwnProperty(i)) {
                    win[TBX_PAGE_TYPE_VAR] = PAGE_TYPES[i];
                    return PAGE_TYPES[i];
                }
            }
            return null;
        }

        /**
         * reset all messages
         */
        function resetAllMessages() {
            requests = [];
            globalMessages = [];
            notifications = [];
            notificationsFirst = [];
            socials = [];
        }

        /**
         * entry point into the message queue.
         * @param arg a single property list or an array of property lists.
         */
        function pushMessage(arg) {
            if (!arg) {
                return;
            }

            if (arg.placement) {
                (TRC.performance && TRC.performance.mark('tbl_push_start', null, arg.placement.replace(/ /g, '_'), 0, 'tblPush', TRC.PerfEvenType.START));
                (TRC.performance && TRC.performance.mark('tbl_push_stop', null, arg.placement.replace(/ /g, '_'), 0, 'tblPush', TRC.PerfEvenType.STOP));
            }

            if (TRC._taboolaClone.length > 50) {
                TRC._taboolaClone = [];
            }
            TRC._taboolaClone.push(arg);
            for (var i = 0; i < arguments.length; i++) {
                arg = arguments[i];
                TRC.pConsole("page", "debug", "push to '_taboola'", arg, "object");
                if (arg instanceof Array) {// got a list of messages
                    for (var j = 0; j < arg.length; j++) {
                        dispatchMessage(arg[j]);
                    }
                } else {
                    dispatchMessage(arg);
                }
            }
            executeMessages();
            return arguments.length;
        }

        /**
         * We must make this Device ID injection before the _taboola.push messages are process so this message will be used before the "flush:true"
         */
        function injectDeviceId() {
            if (config.global['rbox-detect-device-id'] === false) {
                return;
            }

            // This function exist here and in global.js as Util because we might have different versions and I can't
            // make sure both will load in the same time.
            var extractUrlParams = (function () {
                var elementA = document.createElement("a");
                return function (url) {
                    if (!url) {
                        return {};
                    }
                    elementA.href = url;
                    var searchItem;
                    var search = elementA.search;
                    var regexPattern = /\??&?([^=]+)=([^&]+)/gi;
                    var result = {};
                    while (searchItem = regexPattern.exec(search)) {
                        result[searchItem[1]] = searchItem[2];
                    }
                    return result;
                }
            }());

            function extractDeviceId(url) {
                var referrerUrlResult = extractUrlParams(url);
                var redirUrlResult = referrerUrlResult.redir ? extractUrlParams(decodeURIComponent(referrerUrlResult.redir)) : {};
                var dc_data = referrerUrlResult["dc_data"] || redirUrlResult["dc_data"];
                if (dc_data && !!referrerUrlResult["ui"]) {
                    return {
                        deviceId: referrerUrlResult['ui'],
                        dc_data: dc_data
                    };
                }
                return null;
            }

            // Check if we are in AMP before all _taboola.push messages were processed
            var checkIsAmp = function (msg) {
                if (msg instanceof Array) {
                    return msg.filter(checkIsAmp).length > 0;
                }
                return !!msg.mode && msg.framework === 'amp';
            };
            var isAMP = _taboola.filter(checkIsAmp).length > 0;

            var result = (isAMP && window.context && extractDeviceId(window.context.referrer)) || extractDeviceId(window.__tbMockReferrer || document.referrer);
            if (result) {
                _taboola.unshift({
                    device: result.deviceId,
                });
                TRC.taboolaNews = TRC.taboolaNews || {};
                TRC.taboolaNews.timeOn = result;
            }
        }

        function setGloablFlags() {
            TRC.useStorageDetection = (config.global && config.global['use-storage-detection'] === true) ? true : false;
        }

        function injectTaboolaX(host) {
            loadAssetFile(host + "/" + TRC.publisherId + "/load.js", {"async": true});
            TRC.pConsole("page", "info", "injected taboola-x with publisher id : " + TRC.publisherId);
        }

        function activatePerf(enabled, config, force) {
            if (TRC.perfConfOverride) {
                config = TRC.perfConfOverride;
            }

            if (force || (enabled && config && config.traffic)) {
                if (force || (config.traffic > (Math.random() * 100))) {
                    TRC.performance = new TRC.Performance(config);
                }
            }
        }

        function preconnectTo(url) {
            var hint = document.createElement("link");
            hint.rel = "preconnect";
            hint.href = url;
            if (document.head) {
                document.head.appendChild(hint);
            }
        }

        function setResourceHints() {
            if (config.global['enable-resource-hints']) {
                for (var i = 0; i < PRECONNECT_DOMAINS.length; i++) {
                    preconnectTo(TRC.PROTOCOL + '//' + PRECONNECT_DOMAINS[i]);
                }
            }
        }

        // TODO: remove when generic GDPR('enable-consent') is enabled for all publishers
        function getConsentData() {
            var CMP_INTEGRATED = 0,
                CMP_INTEGRATED_NO_RESULT = 1,
                CMP_INTEGRATED_ERROR_ON_RESULT = 2,
                NO_CMP_INTEGRATION = 3;

            TRC.consentData = {};

            if (typeof __cmp === 'function') {
                TRC.consentData.cmpStatus = CMP_INTEGRATED_NO_RESULT;

                try {
                    __cmp('getConsentData', null, function (result) {
                        TRC.consentData.cmpStatus = CMP_INTEGRATED;
                        TRC.consentData.gdprApplies = result.gdprApplies;
                        TRC.consentData.consentDaisyBit = result.consentData;
                    });
                } catch (e) {
                    TRC.consentData.cmpStatus = CMP_INTEGRATED_ERROR_ON_RESULT;

                    TRC.pConsole("page", "error", 'getConsentData: Error calling __cmp api for user consent', e.message);
                }
            } else {
                TRC.consentData.cmpStatus = NO_CMP_INTEGRATION;
            }
        }

        detectBots();

        if (config.global['enable-shift-cdn-domains']) {
            findScriptBaseDomain(doc.getElementsByTagName('script'));
            setLoaderDomains();
        }

        if (TRC.Performance) {
            activatePerf(config.global["enable-analytics"], config.global["config-analytics"], getParameter("taboola-force-perf", win.location));
            (TRC.performance && TRC.performance.mark("2.0"));
        }

        var smartEllipsisUrlParam = getParameter("taboola-smart-ellipsis", win.location);
        if (smartEllipsisUrlParam) {
            config.global["smart-ellipsis"] = smartEllipsisUrlParam === "yes";
        }

        var ellipsisPerfUrlParam = getParameter("taboola-ellipsis-perf", win.location);
        if (ellipsisPerfUrlParam) {
            TRC.ellipsisPerf = ellipsisPerfUrlParam === "yes";
        }

        // If trk.js is loaded to the page - wait for it 'waitForTrkTimeout' milliseconds
        if (TRC.hasTrk && ((TRC.trk.hasRequestEnded && !TRC.trk.hasRequestEnded(TRC.publisherId)) || TRC.trkRequestStatus === undefined)) {
            win.setTimeout(doInitialization, waitForTrkTimeout);
        } else {
            setResourceHints();
            doInitialization();
        }

        function containerExpand(placemenName, containerId) {
            var vhMulti, cont, minHeightConf = config.global["cls-plc-optim-config"];
            if (minHeightConf && minHeightConf[placemenName]) {
                vhMulti = minHeightConf[placemenName]["vhMulti"] || 1;
                cont = document.getElementById(containerId);
                if (cont) {
                    cont.style.minHeight = vhMulti * 100 + "vh";
                }
            }
        }

        function mergeObject(dest, src, depth) {
            if (depth > 10) {
                return;
            }

            for (var o in src) {
                if (src.hasOwnProperty(o)) {
                    var source = src[o];

                    if (typeof source === "object" && (!Array.isArray(source) || config.global['disable-push-array-convert'])) {
                        if (typeof dest[o] === "undefined") {
                            dest[o] = {};
                        }

                        if (typeof dest[o] === "object") {
                            mergeObject(dest[o], source, ++depth);
                        }
                    } else if (o === "experimentID" && dest[o]) {
                        dest[o] = dest[o] + "," + source;
                    } else {
                        dest[o] = source;
                    }
                }
            }
        }


        function doInitialization() {
            setGloablFlags();
            injectDeviceId();
            if (!config.global['enable-shift-cdn-domains']) {
                findScriptBaseDomain(doc.getElementsByTagName('script'));
                setLoaderDomains();
            }
            // hook into the taboola message queue
            queue = win[queueName];
            if (queue.registered) // everything is already active, get out of here
                return;
            queue.push = pushMessage;
            queue.registered = true;
            while (queue.length) {
                pushMessage(queue.shift());
            }

            if (config.global["load-user-agent-data"]) {
                fetchUserAgentData(config.global['high-entropy-values-arguments']);
            }

            // TODO: remove when generic GDPR('enable-consent') is enabled for all publishers
            if (!config.global['enable-consent']) {
                getConsentData();
            }

            if (config.global['enable-visit-value'] && !config.global['load-vv-early']) {
                loadVV();
            }
        }

        function shouldInjectRtus() {
            try {
                if (config.global['enable-real-time-user-sync-for-all-browsers']) {
                    return config.global['enable-real-time-user-sync'];
                }
                return config.global['enable-real-time-user-sync'] &&
                    (/^((?!chrome|android).)*safari/i.test(navigator.userAgent.toLowerCase()) ||
                        navigator.userAgent.toLowerCase().indexOf('firefox') > -1 ||
                        navigator.userAgent.indexOf('Edg') > -1);
            } catch (e) {
                return false;
            }
        }


    }

})(window, document);
